<!DOCTYPE html>
<html class="theme theme-white">
<head>
<meta charset="utf-8">
<title>**Linaro Automated Validation Architecture**</title>
<link href="https://www.zybuluo.com/static/assets/template-theme-white.css" rel="stylesheet" media="screen">
</head>
<body class="theme theme-white">
<div id="wmd-preview" class="wmd-preview wmd-preview-full-reader"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="8hz0" id="linaro-automated-validation-architecture"><strong>Linaro Automated Validation Architecture</strong></h1><p data-anchor-id="wyf4"><code>LAVA</code> <code>Installation</code> <code>Configuration</code> <code>Usage</code></p><hr><p data-anchor-id="4uwd"><div class="toc"><div class="toc">
<ul>
<li><a href="#linaro-automated-validation-architecture">Linaro Automated Validation Architecture</a><ul>
<li><a href="#1-introduction">1 Introduction</a></li>
<li><a href="#2-installation">2 Installation</a><ul>
<li><a href="#21-single-master-instance-installation">2.1 Single Master Instance Installation</a></li>
<li><a href="#22-distributed-instance-installation">2.2 Distributed Instance Installation</a><ul>
<li><a href="#221-remote-worker-configuration">2.2.1 Remote Worker Configuration</a></li>
<li><a href="#222-lava-coordinator-configuration">2.2.2 LAVA Coordinator Configuration</a></li>
<li><a href="#223-sshfs-mount-operations-远程挂载文件系统">2.2.3 SSHFS Mount Operations (远程挂载文件系统)</a></li>
<li><a href="#224-configuring-database-access-from-remote-workers">2.2.4 Configuring Database Access from Remote Workers</a></li>
<li><a href="#225-considerations-for-geographically-separate-masterworker-setups">2.2.5 Considerations for Geographically Separate Master/Worker Setups</a></li>
<li><a href="#226-considerations-of-serial-connections">2.2.6 Considerations of Serial Connections</a></li>
<li><a href="#227-tftp-support-requirement">2.2.7 TFTP Support Requirement</a></li>
<li><a href="#228-lava-pdu-daemon">2.2.8 LAVA PDU Daemon</a></li>
<li><a href="#229-heartbeat">2.2.9 Heartbeat</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#3-usage">3 Usage</a><ul>
<li><a href="#31-create-superuser">3.1 Create Superuser</a></li>
<li><a href="#32-add-device-and-job-submission">3.2 Add Device and Job Submission</a></li>
<li><a href="#33-api">3.3 API</a><ul>
<li><a href="#331-lava-tool">3.3.1 lava-tool</a></li>
<li><a href="#332-xml-rpc-api">3.3.2 XML-RPC API</a></li>
<li><a href="#333-adddevice">3.3.3 add_device</a></li>
<li><a href="#334-lava-dispatch">3.3.4 lava-dispatch</a></li>
<li><a href="#335-lava">3.3.5 lava</a></li>
</ul>
</li>
<li><a href="#34-writing-a-lava-test-definition">3.4 Writing a LAVA Test Definition</a><ul>
<li><a href="#341-contents-of-the-json-file">3.4.1 Contents of the JSON File</a></li>
<li><a href="#342-contents-of-the-yaml-file">3.4.2 Contents of the YAML File</a></li>
</ul>
</li>
<li><a href="#35-lava-test-shell">3.5 LAVA Test Shell</a></li>
</ul>
</li>
<li><a href="#4-usage-in-whaley-platform">4 Usage in Whaley Platform</a><ul>
<li><a href="#41-ldap">4.1 LDAP</a></li>
<li><a href="#42-install-from-source-code">4.2 Install from Source Code</a></li>
</ul>
</li>
<li><a href="#5-faq">5 FAQ</a><ul>
<li><a href="#51-tips">5.1 Tips</a></li>
<li><a href="#52-install-tftp-telnet-ssh">5.2 Install tftp, telnet, ssh</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
</p><hr><div class="md-section-divider"></div><h2 data-anchor-id="0roi" id="1-introduction"><strong>1 Introduction</strong></h2><p data-anchor-id="mks4">What's is LAVA?</p><p data-anchor-id="uk3k">LAVA is the Linaro Automation and Validation Architecture.</p><p data-anchor-id="sdko">LAVA is a continuos integration system for deploying operationg systems onto physical and virtual hardware for running tests. Tests can be simple boot testing, bootloader testing and system level testing, although extra hardware may be required for some system tests. It could be a simple compile or boot test for the kernel, testing whether the code produced by gcc is smaller of faster, whether a kernel scheduler change reduces power consumption for a certain workload, or many other things.</p><p data-anchor-id="lpm8">For more information, please refer to <a href="https://validation.linaro.org/static/docs/overview.html#what-is-lava" target="_blank">https://validation.linaro.org/static/docs/overview.html#what-is-lava</a></p><p data-anchor-id="sgl6"><font color="red"><strong>LAVA Architecture:</strong></font></p><p data-anchor-id="sv8d"><img src="http://static.zybuluo.com/wangbo/6m3k3uz4486esfftv8yft76m/LAVA.png" alt="LAVA Architecture" title=""></p><p data-anchor-id="atc9"><font color="red"><strong>LAVA Components:</strong></font></p><p data-anchor-id="9q7b">lava: meta-package for single instance setup <br>
lava-server: apache, WSGI settings and HTML content <br>
lava-dispatcher: dispatches jobs to devices (focus on this part)</p><blockquote data-anchor-id="lxhi" class="white-blockquote">
  <ul>
  <li><strong>Driver</strong> <br>
  <ul><li>Receive events from other systems <br>
  <ul><li>Continous integration (jenkins, buildbot, etc)</li>
  <li>Image build system (offspring)</li>
  <li>Android build system</li></ul></li>
  <li>Decide on tests to run based on input stream</li>
  <li>Submit templated jobs to the Scheduler</li></ul></li>
  <li><strong>Scheduler</strong> <br>
  <ul><li>Django app</li>
  <li>Web UI for human job creation</li>
  <li>XML-PRC interface for CLI joband automated job submission</li>
  <li>Support pools of similar hardware, schedule to pool or to a specific device</li>
  <li>Scheduler Daemon, Process job queue/Launch dispatchers/Handle job (in) completion/Handle job timeout</li></ul></li>
  <li><strong>Job Dispatcher</strong> <br>
  <ul><li>Jobs defined in json</li>
  <li>job_name - description of the job</li>
  <li>timeout - how long</li>
  <li>target - which machine to run on</li>
  <li>actions <br>
  <ul><li>deploy_linaro_image, hwpack/rootfs...</li>
  <li>boot_linaro_image</li>
  <li>submit_results, server/stream</li></ul></li></ul></li>
  <li><strong>Results Dashboard</strong> <br>
  <ul><li>Django</li>
  <li>XML-PRC</li>
  <li>well-defined, versioned, JSON bundle submissions</li>
  <li>Basic or OpenID authentication</li>
  <li>Supports text or binary attachments</li>
  <li>Reporting</li></ul></li>
  </ul>
</blockquote><p data-anchor-id="dsu9"><img src="http://static.zybuluo.com/wangbo/ldqmgsx4l86uv14sje34k0dn/LAVA%20workflow.png" alt="LAVA Workflow" title=""></p><hr><div class="md-section-divider"></div><h2 data-anchor-id="i8zi" id="2-installation"><strong>2 Installation</strong></h2><p data-anchor-id="awek">Installation Types:</p><blockquote data-anchor-id="hovr" class="white-blockquote">
  <ul>
  <li><strong>Single Master Instance Installation</strong> <br>
  A single instance runs the web frontend, the database, the scheduler and the dispatcher on a single machine. If this machine is also running tests, the device (or devices) under test (DUT) will also need to be connected to this machine, possibly over the network, using USB or using serial cables. <br>
  To install a single master instance and create a superuser, refer to <a href="http://172.16.10.41/static/docs/installing_on_debian.html#debian-installation" target="_blank">Debian-based distributions installation</a>.</li>
  <li><strong>Distributed Instance Installation</strong> <br>
  A single master instance, can also work with one Remote Worker or more, acting as the web frontend and database server for the remote worker(s). Depending on load, the master can also have devices attached. <br>
  This installation type involves the use of two or more machines: <br>
  <ul><li>The master instance is installed and configured on one machine. Refer to <a href="http://172.16.10.41/static/docs/installing_on_debian.html#debian-installation" target="_blank">Debian-based distributions installation</a>.</li>
  <li>On the other machine(s), the Remote Worker is installed and configured. Refer to <a href="http://172.16.10.41/static/docs/distributed-deployment.html#distributed-deployment" target="_blank">Deploying Distributed Instances</a>. <em>Remote Worker: A dispatcher with devices attached which does not have a web frontend but which uses a connection to a remote lava-server to retrieve the list of jobs for supported boards.</em></li></ul></li>
  </ul>
</blockquote><div class="md-section-divider"></div><h3 data-anchor-id="wjcc" id="21-single-master-instance-installation"><strong>2.1 Single Master Instance Installation</strong></h3><p data-anchor-id="yx0m"><font color="red"><strong>Installing on Ubuntu 14.04 LTS/precondition:</strong></font></p><p data-anchor-id="ty3u">LAVA recommends the use of Debian - Ubuntu installs are possible but may not receive updates of the LAVA packages. <strong>Ubuntu Unicorn 14.10 includes all packages needed by LAVA up to the 2014.07 release.</strong> Subsequent releases of Ubuntu will contain newer versions of LAVA and LAVA dependencies.</p><pre data-anchor-id="jh4b"><code>Note: Only 64bit installations are supported for Ubuntu Trusty 14.04 LTS and not all production hot fixes may actually get uploaded to the repository.
</code></pre><p data-anchor-id="onos">Updated versions of lava-server and lava-dispatcher can be obtained from:</p><pre data-anchor-id="u052"><code>deb [arch=amd64] http://images.validation.linaro.org/trusty-repo trusty main
deb http://ppa.launchpad.net/linaro-maintainers/tools/ubuntu precise main
</code></pre><p data-anchor-id="p8ji">This repository is <strong>not a Ubuntu PPA</strong> - it has to be set up manually by adding a file to <code>/etc/apt/sources.list.d/</code> and adding below keys to apt-key.</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="27uc"><ol class="linenums"><li class="L0"><code class="language-shell"><span class="pln">wget http</span><span class="pun">:</span><span class="com">//images.validation.linaro.org/trusty-repo/trusty-repo.key.asc</span></code></li><li class="L1"><code class="language-shell"><span class="pln">sudo apt</span><span class="pun">-</span><span class="pln">key add trusty</span><span class="pun">-</span><span class="pln">repo</span><span class="pun">.</span><span class="pln">key</span><span class="pun">.</span><span class="pln">asc</span></code></li><li class="L2"><code class="language-shell"><span class="pln">wget http</span><span class="pun">:</span><span class="com">//images.validation.linaro.org/staging-repo/staging-repo.key.asc</span></code></li><li class="L3"><code class="language-shell"><span class="pln">sudo apt</span><span class="pun">-</span><span class="pln">key add staging</span><span class="pun">-</span><span class="pln">repo</span><span class="pun">.</span><span class="pln">key</span><span class="pun">.</span><span class="pln">asc</span></code></li><li class="L4"><code class="language-shell"><span class="pln">sudo apt</span><span class="pun">-</span><span class="kwd">get</span><span class="pln"> update</span></code></li></ol></pre><p data-anchor-id="3l5t"><font color="red"><strong>Installing on Ubuntu 15.10/precondition:</strong></font></p><p data-anchor-id="yo78">In Ubuntu 15.10, we don't need to add the source list, just follow below parts. But the source code for Ubuntu 14.04/15.10 is freezed now (no bug fix from LAVA team), the newest documentation version is 2015.08. Since LAVA team will redesign the framework in Debian firstly, then migrate to Ubuntu, this job will done in 2017 probably.</p><p data-anchor-id="elrs"><font color="red"><strong>Next:</strong></font></p><ul data-anchor-id="n1l4">
<li><p><strong>Installing just lava-server</strong> <br>
The <code>lava-server</code> package is the main LAVA scheduler and fronted. To install just lava-server from current packages, use:</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-shell"><span class="pln">sudo apt</span><span class="pun">-</span><span class="kwd">get</span><span class="pln"> install lava</span><span class="pun">-</span><span class="pln">server</span></code></li><li class="L1"><code class="language-shell"><span class="pln">cd </span><span class="pun">/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">apache2</span><span class="pun">/</span><span class="pln">sites</span><span class="pun">-</span><span class="pln">available</span></code></li><li class="L2"><code class="language-shell"><span class="pln">sudo a2dissite </span><span class="lit">000</span><span class="pun">-</span><span class="kwd">default</span><span class="pun">.</span><span class="pln">conf</span></code></li><li class="L3"><code class="language-shell"><span class="pln">sudo a2ensite lava</span><span class="pun">-</span><span class="pln">server</span><span class="pun">.</span><span class="pln">conf</span></code></li><li class="L4"><code class="language-shell"><span class="pln">sudo service apache2 restart</span></code></li></ol></pre>

<p>This will install lava-dispatcher and lava-server. Other packages to consider:</p>

<ul><li><code>lavapdu-client</code> to control a PDU to allow LAVA to automatically power cycle a device</li>
<li><code>lava-daemon</code> only one daemon is required to run multiple PDUs</li>
<li><code>ntp</code> some actions within LAVA can be time-sensitive, so ensuring that devices within your lab keep time correctly can be important</li>
<li>linaro-image-tools which provides <code>linaro-media-create</code> for tests which use hardware packs from Linaro</li></ul></li>
<li><p><strong>Installing the full lava set</strong> <br>
Production installs of LAVA will rarely use the full lava set as it includes tools more commonly used by developers and test labs. These tools mean that the lava package brings more dependencies than when installing <code>lava-server</code> to run a production LAVA instance. <br>
The lava packages support for:</p>

<ul><li><code>lava-dev</code> scripts to build developer packages based on your current git tree of lava-server or lava-dispatcher, including any local changes</li>
<li>linaro-image-tools which provides <code>linaro-media-create</code> for tests which use hardware packs from Linaro</li>
<li><code>vmdebootstrap</code> for building your own Debian based KVM images</li>
<li><code>lavapdu-client</code> to control a PDU to allow LAVA to automatically power cycle a device</li>
<li><code>lavapdu-daemon</code> is recommended or you can use a single daemon for multiple PDUs</li>
<li><p><code>ntp</code> some actions within LAVA can be time-sensitive, so ensuring that devices within your lab keep time correctly can be important <br>
All of these packages can be installed separately alongside the main lava-server package, the lava package merely collects them into one set.</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-shell"><span class="pln">sudo apt</span><span class="pun">-</span><span class="kwd">get</span><span class="pln"> install lava</span></code></li></ol></pre>

<ol><li><p>Choose a standalone master instance of LAVA <code>&lt;Yes&gt;</code> <br>
<img src="http://static.zybuluo.com/wangbo/lfpc88jvb0z0cpuzw9u8qcpn/QQ%E6%88%AA%E5%9B%BE20151229162436.png" alt="single_1" title=""></p></li>
<li><p>Set name for this LAVA instance, any string <br>
<img src="http://static.zybuluo.com/wangbo/ebazbqxikoha6rm1ii887y4o/QQ%E6%88%AA%E5%9B%BE20151229163046.png" alt="single_2" title=""></p></li>
<li><p>Port number of the PostgreSQL database <br>
<img src="http://static.zybuluo.com/wangbo/wkhl1altjs4njvi5mvfwg6x5/QQ%E6%88%AA%E5%9B%BE20151229163536.png" alt="single_3" title=""></p></li>
<li><p>Name for this LAVA instance <br>
<img src="http://static.zybuluo.com/wangbo/ge2prupo0o6gg31oulrj2lkz/QQ%E6%88%AA%E5%9B%BE20151229163838.png" alt="single_4" title=""></p></li>
<li><p>Hostname of your system <br>
<img src="http://static.zybuluo.com/wangbo/ys2upi66u8aalc1pgec1q21w/QQ%E6%88%AA%E5%9B%BE20151229164003.png" alt="single_5" title=""></p></li>
<li><p>Configure nullmailer <br>
<img src="http://static.zybuluo.com/wangbo/p3aoy5vcjbl4vd27ppebyoau/QQ%E6%88%AA%E5%9B%BE20151229164341.png" alt="single_6" title=""> <br>
<img src="http://static.zybuluo.com/wangbo/80r115p0zitfm5t7ccjfluzy/QQ%E6%88%AA%E5%9B%BE20151229164627.png" alt="single_7" title=""></p></li>
<li><p>Configure apache2 <code>/etc/apache2/sites-available/</code></p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-shell"><span class="pln">cd </span><span class="pun">/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">apache2</span><span class="pun">/</span><span class="pln">sites</span><span class="pun">-</span><span class="pln">available</span></code></li><li class="L1"><code class="language-shell"><span class="pln">sudo a2dissite </span><span class="lit">000</span><span class="pun">-</span><span class="kwd">default</span><span class="pun">.</span><span class="pln">conf</span></code></li><li class="L2"><code class="language-shell"><span class="pln">sudo a2ensite lava</span><span class="pun">-</span><span class="pln">server</span><span class="pun">.</span><span class="pln">conf</span></code></li><li class="L3"><code class="language-shell"><span class="pln">sudo service apache2 restart</span></code></li></ol></pre></li>
<li><p>Open your Browser (e.g. Chrome), input <code>localhost</code> or <code>127.0.0.1</code> <br>
<img src="http://static.zybuluo.com/wangbo/k7vx2pkg8luzodi07qc222kn/QQ%E6%88%AA%E5%9B%BE20151229165427.png" alt="single_8" title=""></p></li></ol></li></ul></li>
</ul><p data-anchor-id="hqay"><font color="red"><strong>Issue in Ubuntu 14.04 LTS:</strong></font></p><p data-anchor-id="151v">In step 8, when we want to click the button like <code>Dashboard</code>, <code>Results</code>, <code>Scheduler</code>, <code>API</code>, there's no reaction, so something wrong with this website. From the log, we can see that <code>404 Not Found</code> error occurs when downloading /lava-server/js/bootstrap-3.1.1.min.js.</p><p data-anchor-id="ml3p"><img src="http://static.zybuluo.com/wangbo/3tgvgt2958x6dr4rt16df07r/QQ%E6%88%AA%E5%9B%BE20151229165924.png" alt="single_9" title=""></p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="zuon"><ol class="linenums"><li class="L0"><code class="language-shell"><span class="pln">cd </span><span class="pun">/</span><span class="pln">usr</span><span class="pun">/</span><span class="pln">lib</span><span class="pun">/</span><span class="pln">python2</span><span class="pun">.</span><span class="lit">7</span><span class="pun">/</span><span class="pln">dist</span><span class="pun">-</span><span class="pln">packages</span><span class="pun">/</span><span class="pln">lava_server</span><span class="pun">/</span><span class="pln">lava</span><span class="pun">-</span><span class="pln">server</span><span class="pun">/</span><span class="pln">js</span><span class="pun">/</span></code></li><li class="L1"><code class="language-shell"><span class="pln">ls</span></code></li></ol></pre><p data-anchor-id="d2u5">And no bootstrap-3.1.1.min.js exists, so we should add this js file to relevant directory. You can download this file from <a href="https://github.com/Last-Wizard/LAVA/tree/werewolf/bootstrap" target="_blank">bootstrap-3.1.1.min.js</a>, and then copy it to /usr/lib/python2.7/dist-packages/lava_server/lava-server/js/.</p><div class="md-section-divider"></div><h3 data-anchor-id="eq7j" id="22-distributed-instance-installation"><strong>2.2 Distributed Instance Installation</strong></h3><p data-anchor-id="d85i"><font color="red"><strong>In the Server install Single Instance (e.g. 172.16.10.41), and in the Client (Remote Worker) install Distributed Instance (e.g. 172.16.117.1).</strong></font></p><p data-anchor-id="hxza"><img src="http://static.zybuluo.com/wangbo/hksesgyo4oaknvy1lwd9x1co/1.png" alt="Distributed Instance 1" title=""></p><div class="md-section-divider"></div><h4 data-anchor-id="i5yk" id="221-remote-worker-configuration"><strong>2.2.1 Remote Worker Configuration</strong></h4><p data-anchor-id="2l0p">LAVA server should have an instance name. Each remote worker must be given the instance name of the master lava-server which it will poll for new jobs to run on the devices attached to the worker.</p><p data-anchor-id="v5fm">A remote worker needs to know the network address of the master LAVA server. This can be a hostname or an IP address.</p><p data-anchor-id="9y5c">The remote worker will also need these variables from the master, please refer to <code>/etc/lava-server/instance.conf</code> where you deployed the <strong>Single Instance</strong>:</p><ul data-anchor-id="bakz">
<li>LAVA_DB_SERVER: "localhost" in Server/Master, and the IP address in Client/Slave, e.g. 172.16.10.41</li>
<li>LAVA_DB_NAME: Name of the databse on the master (e.g. lavaserver)</li>
<li>LAVA_DB_USER: Username for the database on the master (e.g. lavaserver)</li>
<li>LAVA_DB_PORT Port number of the database on the master (e.g. 5432)</li>
<li>LAVA_DB_PASSWORD: Password for the database on the master (e.g. GMahdiU3ydpN) <br>
<img src="http://static.zybuluo.com/wangbo/0m32a7m8byitx1lygp8x0zmz/3.png" alt="Distributed Instance 2" title=""> <br>
<img src="http://static.zybuluo.com/wangbo/944kmq70nraxlzzocau5x72d/5.png" alt="Distributed Instance 3" title=""></li>
</ul><div class="md-section-divider"></div><h4 data-anchor-id="z8zy" id="222-lava-coordinator-configuration"><strong>2.2.2 LAVA Coordinator Configuration</strong></h4><p data-anchor-id="pjs1">Only one coordinator is used for each lab, so the remote worker needs to know where to find this coordinator. Specify the hostname or IP address of the master running the coordinator in the <code>/etc/lava-coordinator/lava-coordiantor.conf</code> file on each remote worker:</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="rost"><ol class="linenums"><li class="L0"><code class="language-json"><span class="pun">{</span></code></li><li class="L1"><code class="language-json"><span class="pln">    </span><span class="str">"port"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">3079</span><span class="pun">,</span></code></li><li class="L2"><code class="language-json"><span class="pln">    </span><span class="str">"blocksize"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">4096</span><span class="pun">,</span></code></li><li class="L3"><code class="language-json"><span class="pln">    </span><span class="str">"poll_delay"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">3</span><span class="pun">,</span></code></li><li class="L4"><code class="language-json"><span class="pln">    </span><span class="str">"coordinator_hostname"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"172.16.10.41"</span><span class="pln"> </span><span class="pun">#</span><span class="pln">IP address of </span><span class="typ">Single</span><span class="pln"> </span><span class="typ">Instance</span><span class="pun">#</span></code></li><li class="L5"><code class="language-json"><span class="pun">}</span></code></li></ol></pre><div class="md-section-divider"></div><h4 data-anchor-id="p9wc" id="223-sshfs-mount-operations-远程挂载文件系统"><strong>2.2.3 SSHFS Mount Operations</strong> (远程挂载文件系统)</h4><p data-anchor-id="hfpy">SSH is a secure protocol for communicating between machines. <strong>SSHFS</strong> is a tool that uses SSH to enable mounting of a remote filesystem on a local machine; the network is (mostly) transparent to the user. Because SSHFS authenticates connections, you can be sure that only those who should have access to remote directories can mount them (as long as everything is configured properly).</p><p data-anchor-id="6inv">Because SSH encrypts connections, no one can see your files as they are transferred over the network. And because SSHFS is built using FUSE, even your own root user can only see your files by logging in to your account with su.</p><p data-anchor-id="ts4k">lava-server provides a script to manage the mounting of the media directory over sshfs. On Debian-based distributions, this script remounts the directory each time the <code>lava-server</code> daemon is restarted.</p><p data-anchor-id="z3bc">This mount operation will initially fail until the key is authenticated with the master.</p><ul data-anchor-id="m5im">
<li><p><strong>SSH Key Setup</strong> <br>
The public part of SSH key <strong>must</strong> be appended to the <strong>authorized_keys</strong> file on the master for the SSHFS mount operation to work.</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-bash"><span class="pun">[</span><span class="pln">username_client@Client</span><span class="pun">~]</span><span class="pln">$ ssh</span><span class="pun">-</span><span class="pln">keygen </span><span class="pun">-</span><span class="pln">t rsa </span><span class="pun">-</span><span class="pln">P </span><span class="str">''</span><span class="pln"> </span><span class="com"># executed in Client, generates id_rsa and id_rsa.pub in /home/{username_client}/.ssh,  copy id_rsa.pub file to Server/Master</span></code></li><li class="L1"><code class="language-bash"><span class="pun">[</span><span class="pln">username_server@Server</span><span class="pun">~]</span><span class="pln">$ scp </span><span class="pun">{</span><span class="pln">username_client</span><span class="pun">}@{</span><span class="pln">client_ip</span><span class="pun">}:~/.</span><span class="pln">ssh</span><span class="pun">/</span><span class="pln">id_rsa</span><span class="pun">.</span><span class="pln">pub </span><span class="pun">~/.</span><span class="pln">ssh</span><span class="pun">/</span><span class="pln">id_rsa</span><span class="pun">.</span><span class="pln">pub</span></code></li><li class="L2"><code class="language-bash"><span class="pun">[</span><span class="pln">username_server@Server</span><span class="pun">~]</span><span class="pln">$ cat id_rsa</span><span class="pun">.</span><span class="pln">pub </span><span class="pun">&gt;&gt;</span><span class="pln"> </span><span class="pun">~/.</span><span class="pln">ssh</span><span class="pun">/</span><span class="pln">authorized_keys</span></code></li><li class="L3"><code class="language-bash"><span class="pun">[</span><span class="pln">username_server@Server</span><span class="pun">~]</span><span class="pln">$ sudo gedit </span><span class="pun">/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">ssh</span><span class="pun">/</span><span class="pln">sshd_config </span><span class="com"># edit sshd_config, and enable line 'RSAAuthentication', 'PubkeyAuthentication' and 'AuthorizedKeysFile'</span></code></li><li class="L4"><code class="language-bash"><span class="pun">[</span><span class="pln">username_server@Server</span><span class="pun">~]</span><span class="pln">$ chmod </span><span class="lit">600</span><span class="pln"> </span><span class="pun">~/.</span><span class="pln">ssh</span><span class="pun">/</span><span class="pln">authorized_keys</span></code></li><li class="L5"><code class="language-bash"><span class="pun">[</span><span class="pln">username_server@Server</span><span class="pun">~]</span><span class="pln">$ chmod </span><span class="lit">700</span><span class="pln"> </span><span class="pun">-</span><span class="pln">R </span><span class="pun">~/.</span><span class="pln">ssh</span><span class="pun">/</span></code></li><li class="L6"><code class="language-bash"><span class="pun">[</span><span class="pln">username_client@Client</span><span class="pun">~]#</span><span class="pln"> ssh </span><span class="pun">{</span><span class="pln">server_ip</span><span class="pun">}</span><span class="pln"> </span><span class="pun">-</span><span class="pln">l </span><span class="pun">{</span><span class="pln">username_server</span><span class="pun">}</span><span class="pln"> </span><span class="com"># executed in Client, and input the password. Then you don't need to input the password next time</span></code></li></ol></pre></li>
<li><p><strong>Fuse Configuration</strong> (Filesystem in userspace) <br>
Edit /etc/fuse.conf on the worker and enable the <code>user_allow_other</code> option. <br>
Additionally, you will need to ensure that the <code>fuse</code> and <code>loop</code> kernel modules are loaded, edit /etc/modules-load.d/lava-modules.conf. And <code>sudo modprobe loop &amp; sudo modprobe fuse</code> to enable modules loop and fuse. <br>
Now, we can use ssh to mount &amp; remount the Server filesystem, for example:</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-bash"><span class="pln">sudo mkdir </span><span class="pun">/</span><span class="pln">mnt</span><span class="pun">/</span><span class="pln">fs</span></code></li><li class="L1"><code class="language-bash"><span class="pln">sudo chmod </span><span class="lit">777</span><span class="pln"> </span><span class="pun">/</span><span class="pln">mnt</span><span class="pun">/</span><span class="pln">fs</span></code></li><li class="L2"><code class="language-bash"><span class="pln">sshfs </span><span class="pun">{</span><span class="pln">username_server</span><span class="pun">}@{</span><span class="pln">server_ip</span><span class="pun">}:/</span><span class="pln">home</span><span class="pun">/</span><span class="pln"> </span><span class="pun">/</span><span class="pln">mnt</span><span class="pun">/</span><span class="pln">fs</span><span class="pun">/</span></code></li><li class="L3"><code class="language-bash"><span class="pln">cd </span><span class="pun">/</span><span class="pln">mnt</span><span class="pun">/</span><span class="pln">fs</span></code></li><li class="L4"><code class="language-bash"><span class="pln">ls </span><span class="com"># then all the files in {username_server}:/home/ mount here</span></code></li><li class="L5"><code class="language-bash"><span class="pln">mount </span><span class="com"># bo@172.16.117.50:/home/ on /mnt/fs type fuse.sshfs (rw,nosuid,nodev,user=conan)</span></code></li><li class="L6"><code class="language-bash"><span class="pln">fusermount </span><span class="pun">-</span><span class="pln">u </span><span class="pun">/</span><span class="pln">mnt</span><span class="pun">/</span><span class="pln">fs</span><span class="pun">/</span></code></li></ol></pre></li>
</ul><p data-anchor-id="vla4">If the Server has different username to Client, we must specify the username of the Server when using SSH to login or SSHFS to mount the directory of the Server. So we can modify the config file in ~/.ssh/config to discard the username. Create one file named config in ~/.ssh/, and add below configuration in config in remoter worker:</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="2b0n"><ol class="linenums"><li class="L0"><code><span class="typ">Host</span><span class="pln"> </span><span class="lit">172.16</span><span class="pun">.</span><span class="lit">10.41</span></code></li><li class="L1"><code><span class="pln">    </span><span class="typ">HostName</span><span class="pln"> </span><span class="lit">172.16</span><span class="pun">.</span><span class="lit">10.41</span><span class="pln"> </span><span class="com"># Server ip/Single Instance</span></code></li><li class="L2"><code><span class="pln">    </span><span class="typ">User</span><span class="pln"> </span><span class="pun">{</span><span class="pln">username</span><span class="pun">}</span><span class="pln"> </span><span class="com"># one user account in the Server</span></code></li></ol></pre><p data-anchor-id="llet">An SSH key will have been generated during the configuration of the lava-server package. The public part of this key <code>must</code> be appended to the authorized_keys file on the master for the SSHFS mount operation to work. LAVA created one user account named lavaserver on remote worker and the master for SSHFS. </p><p data-anchor-id="ey5i"><strong>Execute on Remote Worker</strong>: </p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="6rub"><ol class="linenums"><li class="L0"><code><span class="pln">cd </span><span class="pun">/</span><span class="kwd">var</span><span class="pun">/</span><span class="pln">lib</span><span class="pun">/</span><span class="pln">lava</span><span class="pun">-</span><span class="pln">server</span><span class="pun">/</span><span class="pln">home</span></code></li><li class="L1"><code><span class="pln">sudo su lavaserver</span></code></li><li class="L2"><code><span class="pln">pwd </span><span class="com"># /var/lib/lava-server/home</span></code></li><li class="L3"><code><span class="pln">cd </span><span class="pun">.</span><span class="pln">ssh</span></code></li><li class="L4"><code><span class="pln">chmod </span><span class="lit">600</span><span class="pln"> id_rsa</span></code></li><li class="L5"><code><span class="pln">cat id_rsa</span><span class="pun">.</span><span class="pln">pub </span><span class="com"># copy the text to master</span></code></li><li class="L6"><code><span class="kwd">exit</span></code></li></ol></pre><p data-anchor-id="9g1j"><strong>Execute on Master/Single Instance</strong>: </p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="1ig8"><ol class="linenums"><li class="L0"><code><span class="pln">cd </span><span class="pun">/</span><span class="kwd">var</span><span class="pun">/</span><span class="pln">lib</span><span class="pun">/</span><span class="pln">lava</span><span class="pun">-</span><span class="pln">server</span><span class="pun">/</span><span class="pln">home</span></code></li><li class="L1"><code><span class="pln">sudo su lavaserver</span></code></li><li class="L2"><code><span class="pln">cd </span><span class="pun">.</span><span class="pln">ssh</span></code></li><li class="L3"><code><span class="pln">pwd </span><span class="com"># /var/lib/lava-server/home/.ssh</span></code></li><li class="L4"><code><span class="pln">vi authorized_keys </span><span class="com"># copy the id_rsa.pub of Remote Worker to authorized_keys</span></code></li><li class="L5"><code><span class="pln">cd </span><span class="pun">..</span></code></li><li class="L6"><code><span class="pln">chmod </span><span class="lit">700</span><span class="pln"> authorized_keys</span></code></li><li class="L7"><code><span class="pln">chmod </span><span class="lit">600</span><span class="pln"> </span><span class="pun">-</span><span class="pln">R </span><span class="pun">.</span><span class="pln">ssh</span></code></li><li class="L8"><code><span class="kwd">exit</span></code></li></ol></pre><p data-anchor-id="h7ee">Then <code>sudo -u lavaserver ssh lavaserver@172.16.10.41</code>, remote worker can access the master through SSH with account lavaserver, run <code>sudo service lava-server restart</code> in remote worker later, so the worker can mount the /var/lib/lava-server/default/media in master.</p><p data-anchor-id="mhda">LAVA will unmount and re-mount the SSHFS each time when the lava-server daemon is restarted. The SSHFS mount should be visible on the worker:</p><p data-anchor-id="e1x3"><img src="http://static.zybuluo.com/wangbo/35rnape4c37hs64lhba2aabj/mount.png" alt="mount" title=""></p><p data-anchor-id="h3zh">Related scripts: <code>/etc/init.d/lava-server</code> and <code>/usr/sbin/lava-mount-masterfs</code>.</p><div class="md-section-divider"></div><h4 data-anchor-id="n441" id="224-configuring-database-access-from-remote-workers"><strong>2.2.4 Configuring Database Access from Remote Workers</strong></h4><p data-anchor-id="9sd2">Currently, remote workers need to be able to access the master database, so postgres has to be manually configured to allow access from external clients over the network.</p><p data-anchor-id="ijfw">The postgresql database installed by lava-server on the remote worker is redundant and has no data. There is no need to make any changes to the postgresql configuration on any remote worker. The lava-server daemon on each remote worker uses the configuration in <code>/etc/lava-server/instance.conf</code> and <code>/etc/lava-server/worker.conf</code> to make a read/write postgres connection to the master.</p><pre data-anchor-id="0p02"><code>Note: The communication between the remote worker and the master has been re-designed as part of the refactoring. This step will become unnecessary in future, once the instance has migrated all devices to the pipeline. The lava-server and postgresql packages can be removed (and purged) from remote workers when the migration is complete; the postgres configuration on the master can be reset back to the packaging defaults, removing any remote database access from any of the workers.
</code></pre><p data-anchor-id="d72u"><img src="http://static.zybuluo.com/wangbo/e6jdj5yswi6hcmj0yo3fvk6v/6.png" alt="Pipe Architecture" title=""></p><p data-anchor-id="ov07"><strong>Principal Changes:</strong> (enabled in 2017 probably)</p><blockquote data-anchor-id="2gd7" class="white-blockquote">
  <p><strong>Database isolation</strong> - only one daemon has a connection to the database, the master daemon. This simplifies the architecture and avoids the use of fault-intolerant database connections to remote workers. <br>
  <strong>Drop use of SSHFS</strong> between workers and master - this was awkward to configure and problematic over external connections. <br>
  <strong>Move configuration onto the master</strong> - the worker becomes a simple slave which receives all configuration and tasks from the master.</p>
</blockquote><p data-anchor-id="ftnq">The lava-server installation does not dictate how the remote database connection is configured but an example would be to adjust the <code>listen_addresses</code> in postgresql.conf <code>/etc/postgresql/9.3/main/postgresql.conf</code>:</p><pre data-anchor-id="en5q"><code>listen_addresses = '*'
</code></pre><p data-anchor-id="kixb">This sets postgresql to listen to connections on all of the network interfaces available on the master. For remote workers, at least localhost and the IP address of the interface(s) connecting to the remote workers is required.</p><p data-anchor-id="leal">Also adjust the host allowed to connect to this database, so that the LAVA_DB_USER has access to the LAVA_DB_NAME database only by using the LAVA_DB_PASSWORD (which, in turn, is not sent in clear text). This configuration should be made in <code>pg_hba.conf</code>. You can refer to <a href="http://172.16.10.41/static/docs/distributed-deployment.html#example-postgres" target="_blank">Example configuration</a>.</p><pre data-anchor-id="2ex7"><code>host   lavaserver  lavaserver  172.16.117.0/24  md5
# this allow 172.16.117.0 ~ 172.16.117.255 to access this database from remote workers

sudo service postgresql restart
sudo service lava-server restart
# if the IP address of the master running postgres is 172.16.117.50
psql -h 172.16.117.50 -U lavaserver
</code></pre><p data-anchor-id="effq">We can also use python script to connect the database in Server/Single Instance from Client/Remote Worker to verify the configuration, e.g.</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="3u03"><ol class="linenums"><li class="L0"><code class="language-python"><span class="com">#! /usr/bin/python</span></code></li><li class="L1"><code class="language-python"><span class="kwd">import</span><span class="pln"> psycopg2</span></code></li><li class="L2"><code class="language-python"><span class="pln">conn </span><span class="pun">=</span><span class="pln"> psycopg2</span><span class="pun">.</span><span class="pln">connect</span><span class="pun">(</span><span class="pln">database</span><span class="pun">=</span><span class="str">"lavaserver"</span><span class="pun">,</span><span class="pln"> user</span><span class="pun">=</span><span class="str">"lavaserver"</span><span class="pun">,</span><span class="pln"> password</span><span class="pun">=</span><span class="str">"GMahdiU3ydpN"</span><span class="pun">,</span><span class="pln"> host</span><span class="pun">=</span><span class="str">"172.16.117.50"</span><span class="pun">,</span><span class="pln"> port</span><span class="pun">=</span><span class="str">"5432"</span><span class="pun">)</span><span class="pln"> </span><span class="com"># defined in 2.2.1 Remote Worker Configuration</span></code></li><li class="L3"><code class="language-python"><span class="kwd">print</span><span class="pln"> </span><span class="str">"Open database successfully"</span></code></li></ol></pre><p data-anchor-id="4w2c">If there are errors in the postgres connection settings in the instance.conf file, use debconf to update the values:</p><pre data-anchor-id="9jdv"><code>sudo dpkg-reconfigure lava-server 
</code></pre><div class="md-section-divider"></div><h4 data-anchor-id="j2b8" id="225-considerations-for-geographically-separate-masterworker-setups"><strong>2.2.5 Considerations for Geographically Separate Master/Worker Setups</strong></h4><p data-anchor-id="5lfh">A remote worker needs to be able to communicate with the <code>lava_server</code> over SSH and Postgres (standard ports 22 and 5432), so some configuration will be needed if the <code>lava-server</code> is behind a firewall.</p><ul data-anchor-id="0y6e">
<li><font color="red">The DUT console output logs are written to a filesystem that is shared over <strong>SSHFS</strong> from the master lava-server.</font> A side-effect of this is that over high latency links there can be a delay in seeing console output when viewing it on the scheduler job webpage. SSHFS can recover from network problems but a monitoring system to check the mount is still available is preferred</li>
<li>Latency over SSHFS</li>
<li>Log file update speed</li>
<li>Port forwarding behind firewalls</li>
</ul><div class="md-section-divider"></div><h4 data-anchor-id="r757" id="226-considerations-of-serial-connections"><strong>2.2.6 Considerations of Serial Connections</strong></h4><p data-anchor-id="lt37">Modern server or desktop x86 hardware will often have no, or very few, serial ports, but DUT are still often controlled by LAVA over serial. The 2 solutions we use for this in the LAVA lab are dedicated serial console servers or usb-to-serial adaptors. If you plan to use many usb-to-serial adaptors, ensure that your <strong>USB hub has an external power source</strong>. For ease of udev configuration, use a usb-to-serial chipset that supports unique serial numbers, such as FTDI.</p><div class="md-section-divider"></div><h4 data-anchor-id="t2i0" id="227-tftp-support-requirement"><strong>2.2.7 TFTP Support Requirement</strong></h4><p data-anchor-id="krzz">LAVA uses <code>tftp</code> to serve files to a variety of device types.</p><p data-anchor-id="1e40">The current dispatcher relies on TFTP downloads, NFS share directories and master image downloads to all be made from a single directory: <code>/var/lib/lava/dispatcher/tmp</code>. To do this, the configuration file for tftpd-hpa needs to be modified to use the LAVA directory instead of the default, /var/lib/tftpboot.</p><pre data-anchor-id="niq9"><code>Note The TFTP support in LAVA has had to be changed from the 2015.8 release onwards to stop LAVA enforcing a configuration change on the tftpd-hpa package without explicit configuration by the admin. Previously, installation may have prompted about changes in /etc/default/tftpd-hpa, now this change needs to be made manually as the configuration of the tftpd-hpa package should not have been up to LAVA to impose. If you are already running a version of LAVA installed prior to the 2015.8 release (and have working TFTP support), then the configuration change will have been imposed by LAVA and then maintained by dpkg and tftpd-hpa. Check that your /etc/default/tftpd-hpa file references /var/lib/lava/dispatcher/tmp and continue as before.
</code></pre><p data-anchor-id="bdkw">Admins can either manually change the <code>/etc/default/tftpd-hpa</code> to set the <code>TFTP_DIRECTORY</code> to <code>/var/lib/lava/dispatcher/tmp</code> or copy the file packaged by lava-dispatcher:</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="fm95"><ol class="linenums"><li class="L0"><code class="language-bash"><span class="pln">sudo cp </span><span class="pun">/</span><span class="pln">usr</span><span class="pun">/</span><span class="pln">share</span><span class="pun">/</span><span class="pln">lava</span><span class="pun">-</span><span class="pln">dispatcher</span><span class="pun">/</span><span class="pln">tftp</span><span class="pun">-</span><span class="pln">hpa </span><span class="pun">/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">default</span><span class="pun">/</span><span class="pln">tftp</span><span class="pun">-</span><span class="pln">hpa</span></code></li><li class="L1"><code class="language-bash"><span class="pln">sudo service tftpd</span><span class="pun">-</span><span class="pln">hpa restart</span></code></li></ol></pre><div class="md-section-divider"></div><h4 data-anchor-id="cl1v" id="228-lava-pdu-daemon"><strong>2.2.8 LAVA PDU Daemon</strong></h4><p data-anchor-id="lmzc">LAVA provides <code>lavapdu</code> to control PDUs (Power Distribution Unit), inclues three modules: <code>pduclient</code> (/usr/bin), <code>lavapdu-listen</code> (/usr/sbin), <code>lavapdu-runner</code> (/usr/sbin).</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="jal2"><ol class="linenums"><li class="L0"><code class="language-shell"><span class="pln">pduclient </span><span class="pun">--</span><span class="pln">daemon deamonhostname </span><span class="pun">--</span><span class="pln">hostname pduhostname </span><span class="pun">--</span><span class="pln">port pduportnum </span><span class="pun">--</span><span class="pln">command pducommand</span></code></li><li class="L1"><code class="language-shell"><span class="pln">pduclient </span><span class="pun">--</span><span class="pln">daemon localhost </span><span class="pun">--</span><span class="pln">hostname </span><span class="str">'pduhostname/ip'</span><span class="pln"> </span><span class="pun">--</span><span class="pln">port </span><span class="str">'[01|02|03...]'</span><span class="pln"> </span><span class="pun">--</span><span class="pln">command </span><span class="str">'[on|off|reboot]'</span></code></li></ol></pre><p data-anchor-id="80s1">LAVA uses APC PDU in the source code, so we must add driver for our PDU. Here I add a file named <strong>np1601</strong> in /usr/lib/python2.7/dist-packages/lava-pdu/drivers/, and change the corresponding lines in other files.</p><p data-anchor-id="gckb">You can get the latest PDU files from <a href="https://github.com/Last-Wizard/LAVA.git" target="_blank">GitHub</a>, then <code>sudo chmod a+x install &amp; sudo ./install</code>, this script will replace the relevant files automatically and restart services lavapdu-listen &amp; lavapdu-runner.</p><p data-anchor-id="cvcl">Modify the configuration of <code>lavapdu</code>, add below lines to /etc/lavapdu/lavapdu.conf. <code>172.16.117.103</code> is the PDU hostname or IP address, <code>username</code> is the username of PDU, and <code>password</code> is in the same way.</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="s0tz"><ol class="linenums"><li class="L0"><code class="language-json"><span class="pun">{</span></code></li><li class="L1"><code class="language-json"><span class="pln">    </span><span class="str">"daemon"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code class="language-json"><span class="pln">        </span><span class="str">"hostname"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"0.0.0.0"</span><span class="pun">,</span></code></li><li class="L3"><code class="language-json"><span class="pln">        </span><span class="str">"port"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">16421</span><span class="pun">,</span></code></li><li class="L4"><code class="language-json"><span class="pln">        </span><span class="str">"dbhost"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"127.0.0.1"</span><span class="pun">,</span></code></li><li class="L5"><code class="language-json"><span class="pln">        </span><span class="str">"dbuser"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"pdudaemon"</span><span class="pun">,</span></code></li><li class="L6"><code class="language-json"><span class="pln">        </span><span class="str">"dbpass"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"pdudaemon"</span><span class="pun">,</span></code></li><li class="L7"><code class="language-json"><span class="pln">        </span><span class="str">"dbname"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"lavapdu"</span><span class="pun">,</span></code></li><li class="L8"><code class="language-json"><span class="pln">        </span><span class="str">"retries"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">5</span><span class="pun">,</span></code></li><li class="L9"><code class="language-json"><span class="pln">        </span><span class="str">"logging_level"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"INFO"</span></code></li><li class="L0"><code class="language-json"><span class="pln">    </span><span class="pun">},</span></code></li><li class="L1"><code class="language-json"><span class="pln">    </span><span class="str">"pdus"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code class="language-json"><span class="pln">        </span><span class="str">"172.16.117.103"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code class="language-json"><span class="pln">            </span><span class="str">"driver"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"np1601"</span><span class="pun">,</span></code></li><li class="L4"><code class="language-json"><span class="pln">            </span><span class="str">"telnetport"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">23</span><span class="pun">,</span></code></li><li class="L5"><code class="language-json"><span class="pln">            </span><span class="str">"username"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"admin"</span><span class="pun">,</span></code></li><li class="L6"><code class="language-json"><span class="pln">            </span><span class="str">"password"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"admin"</span></code></li><li class="L7"><code class="language-json"><span class="pln">        </span><span class="pun">}</span></code></li><li class="L8"><code class="language-json"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L9"><code class="language-json"><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="abqh">Then you can use <code>pduclient</code> to control the remote PDU &amp; DUT.</p><div class="md-section-divider"></div><h4 data-anchor-id="w84b" id="229-heartbeat"><strong>2.2.9 Heartbeat</strong></h4><p data-anchor-id="sy5h">Each dispatcher worker node sends heartbeat data to the <strong>master node</strong> via xmlrpc. For this feature to work correctly the rpc2_url parameter should be set properly. Login as an admin user and go to <a href="http://validation.whaley.work/admin/lava_scheduler_app/worker/" target="_blank">http://validation.whaley.work/admin/lava_scheduler_app/worker/</a> (please see below parts to add an admin user account). Click on the machine which is your master and in the page that opens, set the <strong>Master RPC2 URL</strong>: with the correct value, if it is not set properly, already. Do not touch any other values in this page except the description, since all the other fields except description is populated automatically. The following figure illustrates this: <font color="red"><strong>172.16.10.41</strong></font>.</p><p data-anchor-id="xyxl"><img src="http://static.zybuluo.com/wangbo/3s9bl8k93o2kj4nptn2qjhu5/Django%20workers.jpg" alt="Django workers" title=""></p><p data-anchor-id="emm2">Sign in to the master django admin interface and scroll down in the Admin home page to Lava_Scheduler_App and select Workers - ensure that the XML_RPC URL is valid. e.g. you may need to put the IP address of the  in place of a local hostname as the worker will need to be able to resolve this address.</p><hr><div class="md-section-divider"></div><h2 data-anchor-id="zil3" id="3-usage"><strong>3 Usage</strong></h2><div class="md-section-divider"></div><h3 data-anchor-id="uxi7" id="31-create-superuser"><strong>3.1 Create Superuser</strong></h3><p data-anchor-id="lqtu">On the master, create a Superusers, if this has not been done already.</p><ul data-anchor-id="rok7">
<li><p><strong>OpenID or LDAP</strong> <br>
In LAVA instances that use external authentication mechanisms such as OpenID or LDAP, login once with the user account that has to be granted superuser privileges on LAVA web UI. After logging in with OpenID or LDAP successfully, make use of the following command to make this user a superuser: <code>sudo lava-server manage authorize_superuser {username}</code>, {username} is the username of OpenID or LDAP user.</p></li>
<li><p><strong>LDAP</strong> <br>
In LAVA instances that use LDAP as authentication mechanism, the addldapuser command can be used to populate a user from LDAP and also grant superuser privilege as follows: <code>sudo lava-server manage addldapuser {username}  --superuser</code>, {username} is the username of LDAP user. For LDAP configuration, please see <a href="http://172.16.10.41/static/docs/installation.html?highlight=ldap" target="_blank">Using LDAP</a>.</p></li>
<li><p><strong><font color="red">Local Django Account</font></strong> <br>
A default lavaserver superuser is setup during package installation with a random password. The default superuser is not the same as the lavaserver system user nor the postgres user (despite the name): <code>sudo lava-server manage createsuperuser --username={username} --email={email}</code>. To delete the dummy superuser, login as this new superuser at <a href="http://validation.whaley.work/admin" target="_blank">http://validation.whaley.work/admin</a> and select Users in the administrator interface. Select lavaserver and click the Delete link at the bottom of the page. <br>
An existing local Django superuser account can be upgraded to an LDAP user account without losing data, using the mergeldapuser command, provided the LDAP username does not already exist in the LAVA instance: <code>sudo lava-server manage mergeldapuser {lava_user} {ldap_user}</code></p></li>
</ul><div class="md-section-divider"></div><h3 data-anchor-id="i9mi" id="32-add-device-and-job-submission"><strong>3.2 Add Device and Job Submission</strong></h3><ul data-anchor-id="lssy">
<li><p><strong>Add a KVM device to LAVA</strong></p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-shell"><span class="pln">sudo </span><span class="pun">/</span><span class="pln">usr</span><span class="pun">/</span><span class="pln">share</span><span class="pun">/</span><span class="pln">lava</span><span class="pun">-</span><span class="pln">server</span><span class="pun">/</span><span class="pln">add_device</span><span class="pun">.</span><span class="pln">py </span><span class="pun">{</span><span class="pln">device_type</span><span class="pun">}</span><span class="pln"> </span><span class="pun">{</span><span class="pln">device_name</span><span class="pun">}</span></code></li><li class="L1"><code class="language-shell"><span class="pln">sudo </span><span class="pun">/</span><span class="pln">usr</span><span class="pun">/</span><span class="pln">share</span><span class="pun">/</span><span class="pln">lava</span><span class="pun">-</span><span class="pln">server</span><span class="pun">/</span><span class="pln">add_device</span><span class="pun">.</span><span class="pln">py kvm kvm01</span></code></li></ol></pre>

<p>Then generate a conf file in /etc/lava-dispatcher/devices/ named kvm01.conf, you can view this device on <a href="http://validation.whaley.work/scheduler/device/kvm01" target="_blank">http://validation.whaley.work/scheduler/device/kvm01</a> or <a href="http://validation.whaley.work/scheduler/device_type/kvm" target="_blank">http://validation.whaley.work/scheduler/device_type/kvm</a>. <br>
All available {device_type} values in <strong>/usr/lib/python2.7/dist-package/lava_dispatcher/default-config</strong>.</p></li>
<li><p><strong>Setup a bundle stream</strong></p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-shell"><span class="pln">lava</span><span class="pun">-</span><span class="pln">tool make</span><span class="pun">-</span><span class="pln">stream </span><span class="pun">--</span><span class="pln">dashboard</span><span class="pun">-</span><span class="pln">url</span><span class="pun">=</span><span class="pln">http</span><span class="pun">:</span><span class="com">//172.16.10.41/RPC2/ /anonymous/{bundle-name}/</span></code></li></ol></pre>

<p>Then generate url <a href="http://validation.whaley.work/dashboard/streams/anonymous/" target="_blank">http://validation.whaley.work/dashboard/streams/anonymous/</a>{bundle-name}/bundles/, bundle stream is something like one folder, with which we can manage all the test results.</p></li>
<li><p><strong>Submit job</strong> <br>
We can submit job through <a href="http://validation.whaley.work/scheduler/jobsubmit" target="_blank">http://validation.whaley.work/scheduler/jobsubmit</a>. A job defines what image to deploy and further actions that should be performed on the DUT. Jobs are defined in JSON files. <br>
Job definition:</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-json"><span class="pun">{</span></code></li><li class="L1"><code class="language-json"><span class="pln">  </span><span class="str">"job_name"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"kvm-test"</span><span class="pun">,</span></code></li><li class="L2"><code class="language-json"><span class="pln">  </span><span class="str">"device_type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"kvm"</span><span class="pun">,</span></code></li><li class="L3"><code class="language-json"><span class="pln">  </span><span class="str">"timeout"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1800</span><span class="pun">,</span></code></li><li class="L4"><code class="language-json"><span class="pln">  </span><span class="str">"actions"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L5"><code class="language-json"><span class="pln">    </span><span class="pun">{</span></code></li><li class="L6"><code class="language-json"><span class="pln">      </span><span class="str">"command"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"deploy_linaro_image"</span><span class="pun">,</span></code></li><li class="L7"><code class="language-json"><span class="pln">      </span><span class="str">"parameters"</span><span class="pun">:</span></code></li><li class="L8"><code class="language-json"><span class="pln">        </span><span class="pun">{</span></code></li><li class="L9"><code class="language-json"><span class="pln">          </span><span class="str">"image"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"http://images.validation.linaro.org/kvm-debian-wheezy.img.gz"</span></code></li><li class="L0"><code class="language-json"><span class="pln">        </span><span class="pun">}</span></code></li><li class="L1"><code class="language-json"><span class="pln">    </span><span class="pun">},</span></code></li><li class="L2"><code class="language-json"><span class="pln">    </span><span class="pun">{</span></code></li><li class="L3"><code class="language-json"><span class="pln">      </span><span class="str">"command"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"boot_linaro_image"</span></code></li><li class="L4"><code class="language-json"><span class="pln">    </span><span class="pun">},</span></code></li><li class="L5"><code class="language-json"><span class="pln">  </span><span class="pun">{</span></code></li><li class="L6"><code class="language-json"><span class="pln">    </span><span class="str">"command"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"submit_results"</span><span class="pun">,</span></code></li><li class="L7"><code class="language-json"><span class="pln">    </span><span class="str">"parameters"</span><span class="pun">:</span></code></li><li class="L8"><code class="language-json"><span class="pln">      </span><span class="pun">{</span></code></li><li class="L9"><code class="language-json"><span class="pln">        </span><span class="str">"server"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"http://172.16.10.41/RPC2/"</span><span class="pun">,</span></code></li><li class="L0"><code class="language-json"><span class="pln">        </span><span class="str">"stream"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"/anonymous/{bundle-name}/"</span></code></li><li class="L1"><code class="language-json"><span class="pln">      </span><span class="pun">}</span></code></li><li class="L2"><code class="language-json"><span class="pln">   </span><span class="pun">}</span></code></li><li class="L3"><code class="language-json"><span class="pln"> </span><span class="pun">]</span></code></li><li class="L4"><code class="language-json"><span class="pun">}</span></code></li></ol></pre>

<p>Please replace the {bundle-name} in json to bundle name you defined in bundle stream. <br>
Add <code>root_part = 1</code> line to the device configuration/kvm01.conf.</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-shell"><span class="pln">sudo gedit </span><span class="pun">/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">modules</span><span class="pun">-</span><span class="pln">load</span><span class="pun">.</span><span class="pln">d</span><span class="pun">/</span><span class="pln">lava_modules</span><span class="pun">.</span><span class="pln">conf </span><span class="com"># "enable loop" in lava_modules.conf</span></code></li><li class="L1"><code class="language-shell"><span class="pln">sudo modprobe loop</span></code></li></ol></pre>

<p>Submit the job, then you can get the execution log in <a href="http://validation.whaley.work/scheduler/alljobs" target="_blank">http://validation.whaley.work/scheduler/alljobs</a>.</p></li>
</ul><div class="md-section-divider"></div><h3 data-anchor-id="2puz" id="33-api"><strong>3.3 API</strong></h3><div class="md-section-divider"></div><h4 data-anchor-id="6aci" id="331-lava-tool"><strong>3.3.1 lava-tool</strong></h4><p data-anchor-id="7ztx"><img src="http://static.zybuluo.com/wangbo/4bmj0aerswq0mm37ut3r18t0/lava-tool.PNG" alt="lava-tool-command" title=""></p><p data-anchor-id="kz0k">Please see <a href="http://validation.whaley.work/static/docs/overview.html#lava-tool-overview" target="_blank">http://validation.whaley.work/static/docs/overview.html#lava-tool-overview</a>, Authentication Tokens &amp; Using lava-tool.</p><ul data-anchor-id="ldr6">
<li>Setup Bundle Stream</li>
<li><p>Job Submission <br>
A job could be submitted either from the command line (using lava-tool) or via the web UI. <br>
Once you hava created a job definition to a file, for example /tmp/job.json, use the lava-tool as shown below:</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-bash"><span class="pln">lava</span><span class="pun">-</span><span class="pln">tool auth</span><span class="pun">-</span><span class="pln">add http</span><span class="pun">://&lt;</span><span class="pln">username</span><span class="pun">&gt;@&lt;</span><span class="pln">server_ip</span><span class="pun">&gt;/</span><span class="pln">RPC2</span><span class="pun">/</span></code></li><li class="L1"><code class="language-bash"><span class="pln">lava</span><span class="pun">-</span><span class="pln">tool submit</span><span class="pun">-</span><span class="pln">job http</span><span class="pun">://&lt;</span><span class="pln">username</span><span class="pun">&gt;@&lt;</span><span class="pln">server_ip</span><span class="pun">&gt;/</span><span class="pln">RPC2</span><span class="pun">/</span><span class="pln"> </span><span class="pun">/</span><span class="pln">tmp</span><span class="pun">/</span><span class="pln">kvm</span><span class="pun">.</span><span class="pln">json</span></code></li></ol></pre>

<p><strong><code>target</code> defined in kvm.json determines which dispatcher to run the relevant job.</strong> if no <code>target</code> defined, then the scheduler will choose one random dispatcher to run the job from all the available devices.</p></li>
</ul><div class="md-section-divider"></div><h4 data-anchor-id="21kj" id="332-xml-rpc-api"><strong>3.3.2 XML-RPC API</strong></h4><p data-anchor-id="n2ps">LAVA Server offers API services as an XML-RPC server. You can interact with it using any XML-RPC client. For example, in python you can do this:</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ytma"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">import</span><span class="pln"> xmlrpclib</span></code></li><li class="L1"><code class="language-python"><span class="pln">server </span><span class="pun">=</span><span class="pln"> xmlrpclib</span><span class="pun">.</span><span class="typ">ServerProxy</span><span class="pun">(</span><span class="str">"http://{server_ip/address}/RPC2"</span><span class="pun">)</span></code></li><li class="L2"><code class="language-python"><span class="kwd">print</span><span class="pln"> server</span><span class="pun">.</span><span class="pln">system</span><span class="pun">.</span><span class="pln">listMethods</span><span class="pun">()</span></code></li></ol></pre><p data-anchor-id="43pp">The following python code shows how to authenticate using an XML-RPC client, when a method requires authentication.</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="igdk"><ol class="linenums"><li class="L0"><code class="language-python"><span class="kwd">import</span><span class="pln"> xmlrpclib</span></code></li><li class="L1"><code class="language-python"><span class="pln">username </span><span class="pun">=</span><span class="pln"> </span><span class="str">"wangbo"</span></code></li><li class="L2"><code class="language-python"><span class="pln">token </span><span class="pun">=</span><span class="pln"> </span><span class="str">"211de3sefh6eup305t1cc8dzm1pf7ge5q4j7500600hucfac4c9xdyz00wo679um7ts3l6aibia41lskl1q8m1ylaouyzso1woyps35agsemo6mxp225qq2lz7unfy5y"</span></code></li><li class="L3"><code class="language-python"><span class="pln">hostname </span><span class="pun">=</span><span class="pln"> </span><span class="str">"172.16.10.41"</span></code></li><li class="L4"><code class="language-python"><span class="pln">server </span><span class="pun">=</span><span class="pln"> xmlrpclib</span><span class="pun">.</span><span class="typ">ServerProxy</span><span class="pun">(</span><span class="str">"http://%s:%s@%s/RPC2"</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">username</span><span class="pun">,</span><span class="pln"> token</span><span class="pun">,</span><span class="pln"> hostname</span><span class="pun">))</span></code></li><li class="L5"><code class="language-python"><span class="kwd">print</span><span class="pln"> server</span><span class="pun">.</span><span class="pln">system</span><span class="pun">.</span><span class="pln">listMethods</span><span class="pun">()</span></code></li><li class="L6"><code class="language-python"><span class="kwd">print</span><span class="pln"> server</span><span class="pun">.</span><span class="pln">system</span><span class="pun">.</span><span class="pln">whoami</span><span class="pun">()</span></code></li></ol></pre><p data-anchor-id="1hoz">For more details, please see <a href="http://validation.whaley.work/api/help/" target="_blank">http://validation.whaley.work/api/help/</a>.</p><div class="md-section-divider"></div><h4 data-anchor-id="9nis" id="333-adddevice"><strong>3.3.3 add_device</strong></h4><p data-anchor-id="h3v6">/usr/share/lava-server/add_device.py <code>devicetype</code> <code>hostname</code> <code>[-p pduport]</code> <code>[-t telnetport]</code> <code>[-b bundlestream]</code> <code>[-s]</code></p><p data-anchor-id="ima9"><img src="http://static.zybuluo.com/wangbo/wyf3rz2aul6oexmnu7x5v13j/add_device.png" alt="add_device" title=""></p><p data-anchor-id="3jpw">Available <code>devicetype</code> exists in two paths: <code>/etc/lava-dispatcher/device-types</code>,  <br>
and <code>/usr/lib/python2.7/dist-packages/lava_dispatcher/default-config/lava-dispatcher/device-types/</code>.</p><p data-anchor-id="r1a2"><code>pduport</code> settings are intended to support lavapdu only. And if we use this parameter <code>-p 01</code>, the config will include below two commands:</p><pre data-anchor-id="ntr8"><code>hard_reset_command = /usr/bin/pduclient --daemon localhost --hostname pdu --command reboot --port 01
power_off_cmd = /usr/bin/pduclient --daemon localhost --hostname pdu --command off --port 01
# pdu is the hostname or IP address of the PDU, like 172.16.117.103
</code></pre><p data-anchor-id="b0gm"><code>telnetport</code> settings are intended to support <font color="red">ser2net</font> only, ser2net port. And if we use this parameter <code>-t 2000</code>, the config will include below command:</p><pre data-anchor-id="7tlu"><code>connection_command = telnet localhost 2000
</code></pre><p data-anchor-id="7koi"><code>bundlestream</code> add a lab health bundle stream if no streams exist.</p><p data-anchor-id="efgc"><code>-s</code> output the data files without adding the device, otherwise file named <code>hostname</code> will be generated in <code>/etc/lava-dispatcher/devices</code>.</p><p data-anchor-id="w8va"><img src="http://static.zybuluo.com/wangbo/9qjrdlibflos0k28manfiamf/add_device_s.png" alt="add_device_s" title=""></p><div class="md-section-divider"></div><h4 data-anchor-id="oh6i" id="334-lava-dispatch"><strong>3.3.4 lava-dispatch</strong></h4><p data-anchor-id="dyw7"><img src="http://static.zybuluo.com/wangbo/c9vspykae1y3idebqtjmbsl5/lava-dispatch.png" alt="lava-dispatch" title=""></p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="r2zd"><ol class="linenums"><li class="L0"><code class="language-json"><span class="pun">{</span></code></li><li class="L1"><code class="language-json"><span class="pln">    </span><span class="str">"actions"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L2"><code class="language-json"><span class="pln">        </span><span class="pun">{</span></code></li><li class="L3"><code class="language-json"><span class="pln">            </span><span class="str">"command"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"deploy_linaro_image"</span><span class="pun">,</span></code></li><li class="L4"><code class="language-json"><span class="pln">            </span><span class="str">"parameters"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code class="language-json"><span class="pln">                </span><span class="str">"image"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"file:///var/lib/lava/dispatcher/kvm-debian-wheezy.img.gz"</span><span class="pln"> </span><span class="pun">#</span><span class="pln"> file</span><span class="pun">/</span><span class="pln">http</span><span class="pun">/</span><span class="pln">scp</span></code></li><li class="L6"><code class="language-json"><span class="pln">            </span><span class="pun">}</span></code></li><li class="L7"><code class="language-json"><span class="pln">        </span><span class="pun">},</span></code></li><li class="L8"><code class="language-json"><span class="pln">        </span><span class="pun">{</span></code></li><li class="L9"><code class="language-json"><span class="pln">            </span><span class="str">"command"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"lava_test_shell"</span><span class="pun">,</span></code></li><li class="L0"><code class="language-json"><span class="pln">            </span><span class="str">"parameters"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L1"><code class="language-json"><span class="pln">                </span><span class="str">"testdef_repos"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L2"><code class="language-json"><span class="pln">                    </span><span class="pun">{</span></code></li><li class="L3"><code class="language-json"><span class="pln">                        </span><span class="str">"git-repo"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"git://git.linaro.org/qa/test-definitions.git"</span><span class="pun">,</span></code></li><li class="L4"><code class="language-json"><span class="pln">                        </span><span class="str">"testdef"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"ubuntu/smoke-tests-basic.yaml"</span></code></li><li class="L5"><code class="language-json"><span class="pln">                    </span><span class="pun">},</span></code></li><li class="L6"><code class="language-json"><span class="pln">                    </span><span class="pun">{</span></code></li><li class="L7"><code class="language-json"><span class="pln">                        </span><span class="str">"git-repo"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"http://git.linaro.org/git/lava-team/lava-functional-tests.git"</span><span class="pun">,</span></code></li><li class="L8"><code class="language-json"><span class="pln">                        </span><span class="str">"testdef"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"lava-test-shell/single-node/singlenode03.yaml"</span></code></li><li class="L9"><code class="language-json"><span class="pln">                    </span><span class="pun">}</span></code></li><li class="L0"><code class="language-json"><span class="pln">                </span><span class="pun">],</span></code></li><li class="L1"><code class="language-json"><span class="pln">                </span><span class="str">"timeout"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">900</span></code></li><li class="L2"><code class="language-json"><span class="pln">            </span><span class="pun">}</span></code></li><li class="L3"><code class="language-json"><span class="pln">        </span><span class="pun">},</span></code></li><li class="L4"><code class="language-json"><span class="pln">        </span><span class="pun">{</span></code></li><li class="L5"><code class="language-json"><span class="pln">            </span><span class="str">"command"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"submit_results_on_host"</span><span class="pun">,</span></code></li><li class="L6"><code class="language-json"><span class="pln">            </span><span class="str">"parameters"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L7"><code class="language-json"><span class="pln">                </span><span class="str">"server"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"http://172.16.10.41/RPC2/"</span><span class="pun">,</span></code></li><li class="L8"><code class="language-json"><span class="pln">                </span><span class="str">"stream"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"/anonymous/{bundle-name}/"</span></code></li><li class="L9"><code class="language-json"><span class="pln">            </span><span class="pun">}</span></code></li><li class="L0"><code class="language-json"><span class="pln">        </span><span class="pun">}</span></code></li><li class="L1"><code class="language-json"><span class="pln">    </span><span class="pun">],</span></code></li><li class="L2"><code class="language-json"><span class="pln">    </span><span class="str">"device_type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"kvm"</span><span class="pun">,</span></code></li><li class="L3"><code class="language-json"><span class="pln">    </span><span class="str">"target"</span><span class="pun">:</span><span class="str">"kvm01"</span><span class="pun">,</span></code></li><li class="L4"><code class="language-json"><span class="pln">    </span><span class="str">"health_check"</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">,</span></code></li><li class="L5"><code class="language-json"><span class="pln">    </span><span class="str">"job_name"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"kvm-single-node"</span><span class="pun">,</span></code></li><li class="L6"><code class="language-json"><span class="pln">    </span><span class="str">"logging_level"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"DEBUG"</span><span class="pun">,</span></code></li><li class="L7"><code class="language-json"><span class="pln">    </span><span class="str">"timeout"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">900</span></code></li><li class="L8"><code class="language-json"><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="skws">To test, we can execute the dispatcher directly with the following command as <code>root</code>.</p><pre data-anchor-id="0tul"><code>lava-dispatch /tmp/kvm.json # json file directory
</code></pre><div class="md-section-divider"></div><h4 data-anchor-id="jyf1" id="335-lava"><strong>3.3.5 lava</strong></h4><ul data-anchor-id="fg51">
<li><p>source code <br>
Please refer to <a href="https://github.com/Last-Wizard/LAVA.git" target="_blank">GitHub</a>, then replace the related files with install script automatically.</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-shell"><span class="pln">cd dist</span><span class="pun">-</span><span class="pln">packages</span></code></li><li class="L1"><code class="language-shell"><span class="pln">chmod a</span><span class="pun">+</span><span class="pln">x install</span></code></li><li class="L2"><code class="language-shell"><span class="pln">sudo </span><span class="pun">./</span><span class="pln">install</span></code></li></ol></pre></li>
<li><p>dispatcher entry points</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-bash"><span class="pun">[</span><span class="pln">lava</span><span class="pun">.</span><span class="pln">commands</span><span class="pun">]</span></code></li><li class="L1"><code class="language-bash"><span class="pln">dispatch </span><span class="pun">=</span><span class="pln"> lava</span><span class="pun">.</span><span class="pln">dispatcher</span><span class="pun">.</span><span class="pln">commands</span><span class="pun">:</span><span class="pln">dispatch</span></code></li><li class="L2"><code class="language-bash"><span class="pln">connect </span><span class="pun">=</span><span class="pln"> lava</span><span class="pun">.</span><span class="pln">dispatcher</span><span class="pun">.</span><span class="pln">commands</span><span class="pun">:</span><span class="pln">connect</span></code></li><li class="L3"><code class="language-bash"><span class="pln">devices </span><span class="pun">=</span><span class="pln"> lava</span><span class="pun">.</span><span class="pln">dispatcher</span><span class="pun">.</span><span class="pln">commands</span><span class="pun">:</span><span class="pln">devices</span></code></li><li class="L4"><code class="language-bash"><span class="pln">power</span><span class="pun">-</span><span class="pln">cycle </span><span class="pun">=</span><span class="pln"> lava</span><span class="pun">.</span><span class="pln">dispatcher</span><span class="pun">.</span><span class="pln">commands</span><span class="pun">:</span><span class="pln">power_cycle</span></code></li><li class="L5"><code class="language-bash"><span class="pun">[</span><span class="pln">lava</span><span class="pun">.</span><span class="pln">signal_handlers</span><span class="pun">]</span></code></li><li class="L6"><code class="language-bash"><span class="pln">add</span><span class="pun">-</span><span class="pln">duration </span><span class="pun">=</span><span class="pln"> lava_dispatcher</span><span class="pun">.</span><span class="pln">signals</span><span class="pun">.</span><span class="pln">duration</span><span class="pun">:</span><span class="typ">AddDuration</span></code></li><li class="L7"><code class="language-bash"><span class="pln">arm</span><span class="pun">-</span><span class="pln">probe </span><span class="pun">=</span><span class="pln"> lava_dispatcher</span><span class="pun">.</span><span class="pln">signals</span><span class="pun">.</span><span class="pln">armprobe</span><span class="pun">:</span><span class="typ">ArmProbe</span></code></li><li class="L8"><code class="language-bash"><span class="pln">shell</span><span class="pun">-</span><span class="pln">hooks </span><span class="pun">=</span><span class="pln"> lava_dispatcher</span><span class="pun">.</span><span class="pln">signals</span><span class="pun">.</span><span class="pln">shellhooks</span><span class="pun">:</span><span class="typ">ShellHooks</span></code></li></ol></pre></li>
</ul><div class="md-section-divider"></div><h3 data-anchor-id="6fgk" id="34-writing-a-lava-test-definition"><strong>3.4 Writing a LAVA Test Definition</strong></h3><p data-anchor-id="3f5l">A Lava Test Definition comprises of two parts: <br>
<font color="red"> <br>
1. the data to setup the test, expressed as a JSON file <br>
2. the instructions to run inside the test, expressed as a YAML file <br>
</font></p><p data-anchor-id="r46q">This allows the same tests to be easily migrated to a range of different devices, environments and purposes by using the same YAML files in multiple JSON files. It also allows tests to be built from a range of components by aggregationg YAML files inside a single JSON file.</p><div class="md-section-divider"></div><h4 data-anchor-id="m9aq" id="341-contents-of-the-json-file"><strong>3.4.1 Contents of the JSON File</strong></h4><p data-anchor-id="b8wn">The JSON file is submitted to the LAVA server and contains:</p><ol data-anchor-id="y490">
<li>demarcation as a <a href="http://172.16.10.41/static/docs/glossary.html#term-health-check" target="_blank">health check</a> or a user test</li>
<li>the default timeout of each action within the test</li>
<li>the <a href="http://172.16.10.41/static/docs/glossary.html#term-logging-level" target="_blank">logging level</a> for the test, DEBUG or INFO</li>
<li>the name of the test, shown in the list of jobs</li>
<li>the location of support files</li>
<li>all parameters necessary to use the support files</li>
<li>the declaration of which device(s) to use for the test</li>
<li>the location to which the results should be uploaded</li>
</ol><p data-anchor-id="tqeu">The JSON determines how the test is deployed onto the device and where to find the tests to be run.</p><p data-anchor-id="kihj">All user tests should use:</p><pre data-anchor-id="t1xx"><code>"health_check": false,
</code></pre><p data-anchor-id="ykdc">See <a href="http://172.16.10.41/static/docs/healthchecks.html#health-checks" target="_blank">Writing Health Checks for device types</a>.</p><p data-anchor-id="ogy4">Multiple tests can be defined in a single JSON file by listing multiple locations of YAML files. Each set of instructions in the YAML files can be run with or without a reboot between each set.</p><p data-anchor-id="wjrm">If a test needs to use more than one device, it is the JSON file which determines which other devices are available within the test and how the test(s) are deployed to the devices in the group.</p><ul data-anchor-id="ulhy">
<li><p><strong>Support files</strong> <br>
These include:</p>

<ol><li>files to boot the device: root filesystem images, kernel images, bootloader parameters</li>
<li>files containint the tests: the YAML files, either alone or as part of repository, are added to the test by LAVA</li></ol>

<p>Using local files: support fiels don not need to be at remote locations, all diles specified in the JSON can be local to the dispatcher executing the test. This is useful for local tests on your own LAVA instance, simply ensure that you use the <code>file:///</code> protocol for support files. Note that a local YAML file will still need to download any custom scripts and required packages from a remote location.</p></li>
<li><p><strong>Initial actions in the JSON</strong> <br>
The simplest tests involve using a pre-built image, a test definition and submission of the results to the server. <br>
Actions defined in the JSON will be executed in the order specified in the JSON file, so a deployment is typically followed by a test shell and then submission of results.</p>

<ol><li><strong>deploy_linaro_image</strong>: Download a complete image (ususlly but not necessarily compressed) containing the kernel, kernel modules and root filesystem. The LAVA overlay will be applied on top before the image boots, to provide access to the LAVA test tools and the test definitions defined in the subsequent actions.</li>
<li><strong>lava_test_shell</strong>: Boots the deployed image and starts the <code>lava_test_runner</code> which starts the execution of the commands defined in the YAML.</li>
<li><strong>submit_results_on_host</strong>: (equivalent to <strong>submit_results</strong>) Collects the result data from the image after the completion of all the commands in the YAML and submits a bundle containing the results and metadata about the job to the server, to be added to the bundle stream listed in the submission. These result bundles can then be viewed, downloaded and used in filters and reports.</li></ol>

<p>See <a href="http://172.16.10.41/static/docs/dispatcher-actions.html#available-actions" target="_blank">List of available dispatcher actions</a>.</p></li>
<li><p><strong>Basic JSON file</strong> <br>
Your first LAVA test should use DEBUG logging so that it is easier to see what is happening. <br>
See <a href="http://172.16.10.41/static/docs/multinode.html#timeouts" target="_blank">Recommendatiosn on timeouts</a> for detailed information on how LAVA handles the timeouts. <br>
Make the <code>job_name</code> descriptive and explanatory, you will want to be able to tell which job is which when reviewing the results. <br>
Make sure device type matches exactly with one of the suitable device types listed on the server to which you want to submit this job. <br>
Change the stream to one which you are allowed to upload results, on your chosen server. If you use <code>localhost</code>, note that this will be replaced by the fully qualified domain name of the server to which the job is submitted.</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-json"><span class="pun">{</span></code></li><li class="L1"><code class="language-json"><span class="str">"health_check"</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">,</span></code></li><li class="L2"><code class="language-json"><span class="str">"logging_level"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"DEBUG"</span><span class="pun">,</span></code></li><li class="L3"><code class="language-json"><span class="str">"timeout"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">900</span><span class="pun">,</span></code></li><li class="L4"><code class="language-json"><span class="str">"job_name"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"kvm-basic-test"</span><span class="pun">,</span></code></li><li class="L5"><code class="language-json"><span class="str">"device_type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"kvm"</span><span class="pun">,</span></code></li><li class="L6"><code class="language-json"><span class="str">"actions"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L7"><code class="language-json"><span class="pln">   </span><span class="pun">{</span></code></li><li class="L8"><code class="language-json"><span class="pln">       </span><span class="str">"command"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"deploy_linaro_image"</span><span class="pun">,</span></code></li><li class="L9"><code class="language-json"><span class="pln">       </span><span class="str">"parameters"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L0"><code class="language-json"><span class="pln">           </span><span class="str">"image"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"http://images.validation.linaro.org/kvm-debian-wheezy.img.gz"</span></code></li><li class="L1"><code class="language-json"><span class="pln">       </span><span class="pun">}</span></code></li><li class="L2"><code class="language-json"><span class="pln">   </span><span class="pun">},</span></code></li><li class="L3"><code class="language-json"><span class="pln">   </span><span class="pun">{</span></code></li><li class="L4"><code class="language-json"><span class="pln">       </span><span class="str">"command"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"lava_test_shell"</span><span class="pun">,</span></code></li><li class="L5"><code class="language-json"><span class="pln">       </span><span class="str">"parameters"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L6"><code class="language-json"><span class="pln">           </span><span class="str">"testdef_repos"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L7"><code class="language-json"><span class="pln">               </span><span class="pun">{</span></code></li><li class="L8"><code class="language-json"><span class="pln">                   </span><span class="str">"git-repo"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"git://git.linaro.org/qa/test-definitions.git"</span><span class="pun">,</span></code></li><li class="L9"><code class="language-json"><span class="pln">                   </span><span class="str">"testdef"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"ubuntu/smoke-tests-basic.yaml"</span></code></li><li class="L0"><code class="language-json"><span class="pln">               </span><span class="pun">}</span></code></li><li class="L1"><code class="language-json"><span class="pln">           </span><span class="pun">],</span></code></li><li class="L2"><code class="language-json"><span class="pln">           </span><span class="str">"timeout"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">900</span></code></li><li class="L3"><code class="language-json"><span class="pln">       </span><span class="pun">}</span></code></li><li class="L4"><code class="language-json"><span class="pln">   </span><span class="pun">},</span></code></li><li class="L5"><code class="language-json"><span class="pln">   </span><span class="pun">{</span></code></li><li class="L6"><code class="language-json"><span class="pln">       </span><span class="str">"command"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"submit_results_on_host"</span><span class="pun">,</span></code></li><li class="L7"><code class="language-json"><span class="pln">       </span><span class="str">"parameters"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L8"><code class="language-json"><span class="pln">           </span><span class="str">"stream"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"/anonymous/{bundle-name}/"</span><span class="pun">,</span></code></li><li class="L9"><code class="language-json"><span class="pln">           </span><span class="str">"server"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"http://172.16.10.41/RPC2/"</span></code></li><li class="L0"><code class="language-json"><span class="pln">       </span><span class="pun">}</span></code></li><li class="L1"><code class="language-json"><span class="pln">   </span><span class="pun">}</span></code></li><li class="L2"><code class="language-json"><span class="pun">]</span></code></li><li class="L3"><code class="language-json"><span class="pun">}</span></code></li></ol></pre>

<p>For more on the contents of the JSON file and how to construct JSON for devices known to LAVA or devices new to LAVA, see the <a href="http://172.16.10.41/static/docs/developing-tests.html#test-developer" target="_blank">Introduction to the LAVA Test Developer Guide</a>.</p></li>
</ul><div class="md-section-divider"></div><h4 data-anchor-id="8qpl" id="342-contents-of-the-yaml-file"><strong>3.4.2 Contents of the YAML File</strong></h4><p data-anchor-id="vejf">The YAML is downloaded from the location specified in the JSON and installed into the test image, either as a single file or as part of a git or bzr repository.</p><p data-anchor-id="bc9c">Each YAML file contains metadata and instructions. Meta includes: <br>
1. a format string recognised by LAVA <br>
2. a short name of the purpose of the file <br>
3. a description of the instructions contained in the file</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="6tg8"><ol class="linenums"><li class="L0"><code><span class="pln">metadata</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">    format</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Lava</span><span class="pun">-</span><span class="typ">Test</span><span class="pln"> </span><span class="typ">Test</span><span class="pln"> </span><span class="typ">Definition</span><span class="pln"> </span><span class="lit">1.0</span></code></li><li class="L2"><code><span class="pln">    name</span><span class="pun">:</span><span class="pln"> singlenode</span><span class="pun">-</span><span class="pln">advanced</span></code></li><li class="L3"><code><span class="pln">    description</span><span class="pun">:</span><span class="pln"> </span><span class="str">"Advanced (level 3): single node test commands for Linux Linaro ubuntu Images"</span></code></li></ol></pre><pre data-anchor-id="uc7q"><code>Note: the short name of the purpose of the test denition, i.e., value of field name, should not contain any non-ascii characters and special characters from the following list, including white space(s): $&amp;"'`()&lt;&gt;/|;
</code></pre><p data-anchor-id="emcf">If the file is not under version control (i.e. not in a git or bzr repository), the version of the file must also be specified in the metadata:</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="e0d1"><ol class="linenums"><li class="L0"><code><span class="pln">metadata</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">    format</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Lava</span><span class="pun">-</span><span class="typ">Test</span><span class="pln"> </span><span class="typ">Test</span><span class="pln"> </span><span class="typ">Definition</span><span class="pln"> </span><span class="lit">1.0</span></code></li><li class="L2"><code><span class="pln">    name</span><span class="pun">:</span><span class="pln"> singlenode</span><span class="pun">-</span><span class="pln">advanced</span></code></li><li class="L3"><code><span class="pln">    description</span><span class="pun">:</span><span class="pln"> </span><span class="str">"Advanced (level 3): single node test commands for Linux Linaro ubuntu Images"</span></code></li><li class="L4"><code><span class="pln">    version</span><span class="pun">:</span><span class="pln"> </span><span class="str">"1.0"</span></code></li></ol></pre><p data-anchor-id="trmf">There are also optional metadata fields: <br>
1. the email address of the maintainer of this file <br>
2. a list of the operating systems which this file can support <br>
3. a list of devices which are expected to be able to run these instructions</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="enyv"><ol class="linenums"><li class="L0"><code><span class="pln">maintainer</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">    </span><span class="pun">-</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">user@linaro</span><span class="pun">,</span><span class="pln">org</span></code></li><li class="L2"><code><span class="pln">os</span><span class="pun">:</span></code></li><li class="L3"><code><span class="pln">    </span><span class="pun">-</span><span class="pln"> ubuntu</span></code></li><li class="L4"><code><span class="pln">scope</span><span class="pun">:</span></code></li><li class="L5"><code><span class="pln">    </span><span class="pun">-</span><span class="pln"> functional</span></code></li><li class="L6"><code><span class="pln">devices</span><span class="pun">:</span></code></li><li class="L7"><code><span class="pln">    </span><span class="pun">-</span><span class="pln"> kvm</span></code></li><li class="L8"><code><span class="pln">    </span><span class="pun">-</span><span class="pln"> arndale</span></code></li><li class="L9"><code><span class="pln">    </span><span class="pun">-</span><span class="pln"> panda</span></code></li><li class="L0"><code><span class="pln">    </span><span class="pun">-</span><span class="pln"> beaglebone</span><span class="pun">-</span><span class="pln">black</span></code></li><li class="L1"><code><span class="pln">    </span><span class="pun">-</span><span class="pln"> beagle</span><span class="pun">-</span><span class="pln">xm</span></code></li></ol></pre><p data-anchor-id="ha5n">The instructions within the YAML file can include installation requirements for images based on supported distributions (currently, Ubuntu or Debian):</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="5a23"><ol class="linenums"><li class="L0"><code><span class="pln">install</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">    deps</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> curl</span></code></li><li class="L3"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> realpath</span></code></li><li class="L4"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> ntpdate</span></code></li><li class="L5"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> lsb</span><span class="pun">-</span><span class="pln">release</span></code></li><li class="L6"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> usbutils</span></code></li></ol></pre><pre data-anchor-id="qwto"><code>Note: the test must raise a usable network interface without running any instructions from the rest of the YAML file or the installation will fail. If this is not always possible, raise a network interface manually as a run step and install or build the components directly.
</code></pre><p data-anchor-id="89my">The principle purpose of the YAML is to run commands on the device and these are specified in the run steps:</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="oc62"><ol class="linenums"><li class="L0"><code><span class="pln">run</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">    steps</span><span class="pun">:</span></code></li></ol></pre><ul data-anchor-id="sqrl">
<li><p><strong>Writing commands to run on the device</strong></p>

<ol><li>All commands need to be executables available on the device. This is why the metadata includes an "os" flag, so that commands specific to that operating system can be accessed.</li>
<li>All tests run in a dedicated working directory. If a repository is used, all files in the repository copy on the device will be in the same directory structure as the repository inside this working directory.</li>
<li>Avoid assumptions about the base system - if a test needs a particular interpreter, executable or environment, ensure that this is available either by using the installation step in the YAML or by building or installing the components as a series of commands in the run steps. Many images will not contain any servers or compilers, many will only have a limited range of interpreters installed and some of those may have reduced functionality.</li>
<li>Keep the YAML files relatively small and clean to promote easier reuse in other tests or devices. It is often better to have many YAML files to be run in sequence than to have a large overly complex YAML file within which some tests will fail due to changed assumptions. e.g. a smoke test YAML file which checks for USB devices is not useful on devices where <code>lsusb</code> is not functional. It is much easier to scan through the test results if the baseline for the test is that all tests should be expected to pass on all supported platforms.</li>
<li>Avoid use of redirects and pipes inside the run steps. If the command needs to use redirection and/or pipes, use a custom script in your repository and execute that script instead. </li>
<li><p>Take care with YAML syntax. These lines will fail with wrong syntax:</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pun">-</span><span class="pln"> echo </span><span class="str">"test1: pass"</span></code></li><li class="L1"><code><span class="pun">-</span><span class="pln"> echo test2</span><span class="pun">:</span><span class="pln"> fail</span></code></li></ol></pre>

<p>When this synax will pass:</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pun">-</span><span class="pln"> echo </span><span class="str">"test1:"</span><span class="pln"> </span><span class="str">"pass"</span></code></li><li class="L1"><code><span class="pun">-</span><span class="pln"> echo </span><span class="str">"test2:"</span><span class="pln"> </span><span class="str">"fail"</span></code></li></ol></pre></li></ol></li>
<li><p><strong>Writing custom scripts to support tests</strong> <br>
When multiple actions are necessary to get usable output, writing a custom script to go alongside the YAML and execute that script as a run step:</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">run</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">    steps</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> $</span><span class="pun">(./</span><span class="kwd">my</span><span class="pun">-</span><span class="pln">script</span><span class="pun">.</span><span class="pln">sh arguments</span><span class="pun">)</span></code></li></ol></pre>

<p>You can choose whatever scripting language you prefer, as long as you ensure that it is available in the test image. <br>
Take care when using <code>cd</code> inside custom scripts - always store the initial return value or the value of <code>pwd</code> before the call and change back to that directory at the end of the script. <br>
Script intepreters:</p>

<ol><li><strong>shell</strong> - consider running the script with <code>set -x</code> to see the operation of the script in the LAVA log files. Ensure that if your script expects <code>bash</code>, use the bash shebang line <code>#!/bin/bash</code> and ensure that <code>bash</code> is installed in the test image. The default shell may be <code>busybox</code>, so take care with non-POSIX constructs in your shell scripts if you use <code>#!/bin/sh</code></li>
<li><strong>python</strong> - ensure that python is installed in the test image. Add all the python dependencies necessary for your script.</li>
<li><strong>perl</strong> - ensure that any modules required by your script are available, bearing in mind that same images may only have the base perl install or a limited selection of modules.</li></ol>

<p>If your YAML file does not reside in a repository, the YAML run steps will need to ensure that a network interface is raised, install a tool like <code>wget</code> and then use that to obtain the script, setting permissions if appropriate.</p></li>
<li><p><strong>Using commands as test cases</strong> <br>
If all your test does is feed the textual output of commands to the log file, you will spend a lot of time reading log files. To make test results eaier to parse, aggregate and compare, individual commands can be converted into test cases with a pass or fail result. The simplest way to use the exit value of the commands. A non-zero exit value is a test case failure. This produces a simple list of passes and failures in the result bundle which can be easily tracked over time. <br>
To use the exit value, simple precede the command with a call to <code>lava-test-case</code> with a test-case name (no spaces):</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">run</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">    steps</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> lava</span><span class="pun">-</span><span class="pln">test</span><span class="pun">-</span><span class="kwd">case</span><span class="pln"> test</span><span class="pun">-</span><span class="pln">ls</span><span class="pun">-</span><span class="pln">command </span><span class="pun">--</span><span class="pln">shell ls </span><span class="pun">/</span><span class="pln">usr</span><span class="pun">/</span><span class="pln">bin</span><span class="pun">/</span><span class="pln">sort</span></code></li><li class="L3"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> lava</span><span class="pun">-</span><span class="pln">test</span><span class="pun">-</span><span class="kwd">case</span><span class="pln"> test</span><span class="pun">-</span><span class="pln">ls</span><span class="pun">-</span><span class="pln">fail </span><span class="pun">--</span><span class="pln">shell ls </span><span class="pun">/</span><span class="pln">usr</span><span class="pun">/</span><span class="pln">somewhere</span><span class="pun">/</span><span class="kwd">else</span></code></li></ol></pre></li>
<li><p><strong>Parsing command outputs</strong> <br>
If the test involves parsing the output of a command rather than simply relying on the exit value, LAVA can use a pass/fail/skip/unknown output:</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">run</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">    steps</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> echo </span><span class="str">"test1:"</span><span class="pln"> </span><span class="str">"pass"</span></code></li><li class="L3"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> echo </span><span class="str">"test2:"</span><span class="pln"> </span><span class="str">"fail"</span></code></li><li class="L4"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> echo </span><span class="str">"test3:"</span><span class="pln"> </span><span class="str">"skip"</span></code></li><li class="L5"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> echo </span><span class="str">"test4:"</span><span class="pln"> </span><span class="str">"unknown"</span></code></li></ol></pre>

<p>The quotes are required to ensure correct YAML parsing. <br>
The parse section can supply a parser to convert the output into test case results:</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">parse</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">    pattern</span><span class="pun">:</span><span class="pln"> </span><span class="str">"(?P&lt;test_case_id&gt;.*-*):\\s+(?P&lt;result&gt;(pass|fail))"</span></code></li></ol></pre>

<p>The result of the above test would be a result bundle:</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">test1 </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="kwd">pass</span></code></li><li class="L1"><code><span class="pln">test2 </span><span class="pun">-&gt;</span><span class="pln"> fail</span></code></li><li class="L2"><code><span class="pln">test3 </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="kwd">pass</span></code></li><li class="L3"><code><span class="pln">test4 </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="kwd">pass</span></code></li></ol></pre></li>
<li><p><strong>Recording test case results</strong> <br>
<code>lava-test-case</code> can also be used with a parser with the extra support for <strong>checking the exit value of the call</strong>:</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">run</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">    steps</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> echo </span><span class="str">"test1:"</span><span class="pln"> </span><span class="str">"pass"</span></code></li><li class="L3"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> echo </span><span class="str">"test2:"</span><span class="pln"> </span><span class="str">"fail"</span></code></li><li class="L4"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> lava</span><span class="pun">-</span><span class="pln">test</span><span class="pun">-</span><span class="kwd">case</span><span class="pln"> echo1 </span><span class="pun">--</span><span class="pln">shell echo </span><span class="str">"test3:"</span><span class="pln"> </span><span class="str">"pass"</span></code></li><li class="L5"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> lava</span><span class="pun">-</span><span class="pln">test</span><span class="pun">-</span><span class="kwd">case</span><span class="pln"> echo2 </span><span class="pun">--</span><span class="pln">shell echo </span><span class="str">"test4:"</span><span class="pln"> </span><span class="str">"fail"</span></code></li></ol></pre>

<p>This syntax will result in extra test results:</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">test1 </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="kwd">pass</span></code></li><li class="L1"><code><span class="pln">test2 </span><span class="pun">-&gt;</span><span class="pln"> fail</span></code></li><li class="L2"><code><span class="pln">test3 </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="kwd">pass</span></code></li><li class="L3"><code><span class="pln">test4 </span><span class="pun">-&gt;</span><span class="pln"> fail</span></code></li><li class="L4"><code><span class="pln">echo1 </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="kwd">pass</span></code></li><li class="L5"><code><span class="pln">echo2 </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="kwd">pass</span></code></li></ol></pre>

<p>Note that <code>echo2</code> passed because the <code>echo "test4:" "fail"</code> returned an exit code of zero. <br>
Alternatively, the <code>--result</code> command can be used to output the value to be picked up by the parser:</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">run</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">    steps</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> echo </span><span class="str">"test1:"</span><span class="pln"> </span><span class="str">"pass"</span></code></li><li class="L3"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> echo </span><span class="str">"test2:"</span><span class="pln"> </span><span class="str">"fail"</span></code></li><li class="L4"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> lava</span><span class="pun">-</span><span class="pln">test</span><span class="pun">-</span><span class="kwd">case</span><span class="pln"> test5 </span><span class="pun">--</span><span class="pln">result </span><span class="kwd">pass</span></code></li><li class="L5"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> lava</span><span class="pun">-</span><span class="pln">test</span><span class="pun">-</span><span class="kwd">case</span><span class="pln"> test6 </span><span class="pun">--</span><span class="pln">result fail</span></code></li></ol></pre>

<p>This syntax will result in the rest results:</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">test1 </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="kwd">pass</span></code></li><li class="L1"><code><span class="pln">test2 </span><span class="pun">-&gt;</span><span class="pln"> fail</span></code></li><li class="L2"><code><span class="pln">test5 </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="kwd">pass</span></code></li><li class="L3"><code><span class="pln">test6 </span><span class="pun">-&gt;</span><span class="pln"> fail</span></code></li></ol></pre></li>
<li><p><strong>Recording test case measurements and units</strong> <br>
Various tests require measurements and <code>lava-test-case</code> supports measurements and unita per test at a precision of 10 digits. <code>--result</code> must always be specified.</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">run</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">    steps</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> echo </span><span class="str">"test1:"</span><span class="pln"> </span><span class="str">"pass"</span></code></li><li class="L3"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> echo </span><span class="str">"test2:"</span><span class="pln"> </span><span class="str">"fail"</span></code></li><li class="L4"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> lava</span><span class="pun">-</span><span class="pln">test</span><span class="pun">-</span><span class="kwd">case</span><span class="pln"> test5 </span><span class="pun">--</span><span class="pln">result </span><span class="kwd">pass</span><span class="pln"> </span><span class="pun">--</span><span class="pln">measurement </span><span class="lit">99</span><span class="pln"> </span><span class="pun">--</span><span class="pln">units bottles</span></code></li><li class="L5"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> lava</span><span class="pun">-</span><span class="pln">test</span><span class="pun">-</span><span class="kwd">case</span><span class="pln"> test6 </span><span class="pun">--</span><span class="pln">result fail </span><span class="pun">--</span><span class="pln">measurement </span><span class="lit">0</span><span class="pln"> </span><span class="pun">--</span><span class="pln">units mugs</span></code></li></ol></pre>

<p>This syntax will result in the test results:</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">test1 </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="kwd">pass</span></code></li><li class="L1"><code><span class="pln">test2 </span><span class="pun">-&gt;</span><span class="pln"> fail</span></code></li><li class="L2"><code><span class="pln">test5 </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="kwd">pass</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">99.0000000000</span><span class="pln"> bottles</span></code></li><li class="L3"><code><span class="pln">test6 </span><span class="pun">-&gt;</span><span class="pln"> fail </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="lit">0E-10</span><span class="pln"> mugs</span></code></li></ol></pre>

<p>The simplest way to use this with real data is to use a custom script which runs <code>lava-test-case</code> with the relevant arguments.</p></li>
</ul><div class="md-section-divider"></div><h3 data-anchor-id="coy2" id="35-lava-test-shell"><strong>3.5 LAVA Test Shell</strong></h3><p data-anchor-id="2gml">The <code>lava_test_shell</code> action provides a way to employ a more black-box style testing approach with the target device. The test definition formats is quite flexible and allows for some interesting things.</p><p data-anchor-id="vigf">A minimal test definition looks like this:</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="jves"><ol class="linenums"><li class="L0"><code><span class="pln">metadata</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">    name</span><span class="pun">:</span><span class="pln"> passfail</span></code></li><li class="L2"><code><span class="pln">    format</span><span class="pun">:</span><span class="pln"> </span><span class="str">"Lava-Test-Shell Test Definition 1.0"</span></code></li><li class="L3"><code><span class="pln">    description</span><span class="pun">:</span><span class="pln"> </span><span class="str">"A simple passfail test for demo."</span></code></li><li class="L4"><code><span class="pln">    os</span><span class="pun">:</span></code></li><li class="L5"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> ubuntu</span></code></li><li class="L6"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> openembedded</span></code></li><li class="L7"><code><span class="pln">    devices</span><span class="pun">:</span></code></li><li class="L8"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> origen</span></code></li><li class="L9"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> panda</span></code></li><li class="L0"><code><span class="pln">    environment</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> lava</span><span class="pun">-</span><span class="pln">test</span><span class="pun">-</span><span class="pln">shell</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="kwd">params</span><span class="pun">:</span></code></li><li class="L4"><code><span class="pln">    TEST_1</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">pass</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">run</span><span class="pun">:</span></code></li><li class="L7"><code><span class="pln">    steps</span><span class="pun">:</span></code></li><li class="L8"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> echo </span><span class="str">"test-1: $TEST_1"</span></code></li><li class="L9"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> echo </span><span class="str">"test-2: fail"</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="pln">parse</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">    pattern</span><span class="pun">:</span><span class="pln"> </span><span class="str">"(?P&lt;test_case_id&gt;.*-*):\\s+(?P&lt;result&gt;(pass|fail))"</span></code></li></ol></pre><pre data-anchor-id="l3a0"><code>Note: The parse pattern has similar quoting rules as Python, so \s must be escaped as \\s and similar.
</code></pre><p data-anchor-id="dhvu">However, the parameters such as os, devices, environment are optional in the metadata section. <font color="red">On the other hand parameters such as name, format, description are mandatory in the metadata section.</font></p><ul data-anchor-id="kq2o">
<li><p>Versioned test definitions <br>
If your test definition is not part of a bzr or git repository then it is mandatory to have a <strong>version</strong> parameter in metadata section. The following example show how a test definition metadata section will look like for a test which is not part of bzr or git repository.</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">metadata</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">    name</span><span class="pun">:</span><span class="pln"> passfail</span></code></li><li class="L2"><code><span class="pln">    format</span><span class="pun">:</span><span class="pln"> </span><span class="str">"Lava-Test-Shell Test Definition 1.0"</span></code></li><li class="L3"><code><span class="pln">    version</span><span class="pun">:</span><span class="pln"> </span><span class="str">"1.0"</span></code></li><li class="L4"><code><span class="pln">    description</span><span class="pun">:</span><span class="pln"> </span><span class="str">"A simple passfail test for demo."</span></code></li><li class="L5"><code><span class="pln">    os</span><span class="pun">:</span></code></li><li class="L6"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> ubuntu</span></code></li><li class="L7"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> openembedded</span></code></li><li class="L8"><code><span class="pln">    devices</span><span class="pun">:</span></code></li><li class="L9"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> origen</span></code></li><li class="L0"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> panda</span></code></li><li class="L1"><code><span class="pln">    environment</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">        </span><span class="pun">-</span><span class="pln"> lava</span><span class="pun">-</span><span class="pln">test</span><span class="pun">-</span><span class="pln">shell</span></code></li></ol></pre></li>
<li><p>How a lava test shell is run <br>
A lava-test-shell is run by:  <br>
<font color="red"></font></p><font color="red">

<ul><li>compiling the above test definition into a shell script</li>
<li>copying this script onto the device and arranging for it to be run when the device boots</li>
<li>booting the device and letting the test run</li>
<li>retrieving the output from the device and turning it into a test result bundle</li>
<li>run subsequent test definitions, if any</li></ul>

</font><p><font color="red"></font></p></li>
</ul><hr><div class="md-section-divider"></div><h2 data-anchor-id="elwg" id="4-usage-in-whaley-platform"><strong>4 Usage in Whaley Platform</strong></h2><ol data-anchor-id="lria">
<li>add devices, bind devices to different ser2net port (3.3.2 add_device). Create one device type name <code>mstar</code>, and configure mstar.conf. Add different mstar DUT to LAVA/Remote Worker based on mstar.conf (for MStar platform only). And for Hisi platform, we should add one file named hisi.conf in <code>/usr/lib/python2.7/dist-packages/lava_dispatcher/default-config/lava-dispatcher/device-types</code> then add hisi devices based on this device type. In the future, if we have another new platform named "xx", we must add "xx.conf" firstly. <br>
<img src="http://static.zybuluo.com/wangbo/7mq7cds9smsnjvzfi60e5asa/Catch%2804-14-14-22-17%29.jpg" alt="DUT layout" title=""> <br>
All MStar devices connect to PC-DQA3, and Hisi devices connect to PC-DQA.</li>
<li><p>ser2net connection <br>
<code>ser2net</code> provides a way for a user to connect from a network connection to a serial port, usually over telnet. ser2net is a dependency of lava-dispatcher, so will be installed automatically. Example config (in /etc/ser2net.conf): <br>
<img src="http://static.zybuluo.com/wangbo/ddf8wfoycle1on92serc84rb/CatchBC8D%2803-01-10-10-44%29.jpg" alt="ser2net conf" title=""> <br>
<img src="http://static.zybuluo.com/wangbo/ruis8kzdpsme1zzqyv5ph5xa/CatchB71A%2803-01-10-10-44%29.jpg" alt="/sys/class/tty" title=""></p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="typ">This</span><span class="pln"> </span><span class="kwd">is</span><span class="pln"> comment</span><span class="pun">:</span><span class="pln"> port</span><span class="pun">:</span><span class="pln">connectiontype</span><span class="pun">:</span><span class="pln">idle_timeout</span><span class="pun">:</span><span class="pln">serial_device</span><span class="pun">:</span><span class="pln">baudrate databit parity stopbit</span></code></li><li class="L1"><code><span class="lit">6000</span><span class="pun">:</span><span class="pln">telnet</span><span class="pun">:</span><span class="lit">0</span><span class="pun">:</span><span class="str">/dev/</span><span class="pln">serial_port1</span><span class="pun">:</span><span class="lit">115200</span><span class="pln"> </span><span class="lit">8DATABITS</span><span class="pln"> NONE </span><span class="lit">1STOPBIT</span></code></li></ol></pre>

<p>If the dispatcher IP address is 192.168.1.228, then we can use <code>telnet 192.168.1.228 6000</code> to connect to the device. <code>connection_command = telnet 192.168.1.228 6000</code> <br>
<del>Since the serial number may changed after PC reboot, so we must traverse the definition in /sys/class/tty/ and modify the corresponding device defined in ser2net.conf.</del></p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">git clone https</span><span class="pun">:</span><span class="com">//github.com/Last-Wizard/LAVA.git</span></code></li><li class="L1"><code><span class="pln">cd ser2net</span></code></li><li class="L2"><code><span class="pln">sudo cp configure_ser2net</span><span class="pun">.</span><span class="pln">py </span><span class="pun">/</span><span class="pln">usr</span><span class="pun">/</span><span class="pln">bin</span><span class="pun">/</span></code></li><li class="L3"><code><span class="typ">This</span><span class="pln"> </span><span class="kwd">is</span><span class="pln"> comment</span><span class="pun">:</span><span class="pln"> add below line </span><span class="kwd">in</span><span class="pln"> </span><span class="pun">/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">init</span><span class="pun">.</span><span class="pln">d</span><span class="pun">/</span><span class="pln">lava</span><span class="pun">-</span><span class="pln">server</span><span class="pun">,</span><span class="pln"> </span></code></li><li class="L4"><code><span class="typ">This</span><span class="pln"> </span><span class="kwd">is</span><span class="pln"> comment</span><span class="pun">:</span><span class="pln"> do_start</span><span class="pun">()</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">,</span><span class="pln"> under line </span><span class="str">'lava-mount-masterfs || true'</span></code></li><li class="L5"><code><span class="pln">python </span><span class="pun">/</span><span class="pln">usr</span><span class="pun">/</span><span class="pln">bin</span><span class="pun">/</span><span class="pln">configure_ser2net</span><span class="pun">.</span><span class="pln">py</span></code></li></ol></pre>

<p>When we restart the PC or restart the lava-server service, this script will be called automatically, and sync the ser2net.conf.</p></li>
<li>use "deploy_whaley_image" and "boot_whaley_image" to download the image to DUT</li>
<li><p>use "whaley_test_shell" to call a local/user defined script <br>
One job demo named "/tmp/whaley.json":</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-json"><span class="pun">{</span></code></li><li class="L1"><code class="language-json"><span class="str">"actions"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L2"><code class="language-json"><span class="pln">    </span><span class="pun">{</span></code></li><li class="L3"><code class="language-json"><span class="pln">        </span><span class="str">"command"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"deploy_whaley_image"</span><span class="pun">,</span></code></li><li class="L4"><code class="language-json"><span class="pln">        </span><span class="str">"parameters"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code class="language-json"><span class="pln">            </span><span class="str">"image"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"h02p55-development/H02P55D-01.07.01-1604503-164/helios/auto_update.txt"</span><span class="pun">,</span></code></li><li class="L6"><code class="language-json"><span class="pln">            </span><span class="str">"image_server_ip"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"172.16.11.28"</span></code></li><li class="L7"><code class="language-json"><span class="pln">        </span><span class="pun">}</span></code></li><li class="L8"><code class="language-json"><span class="pln">    </span><span class="pun">},</span></code></li><li class="L9"><code class="language-json"><span class="pln">    </span><span class="pun">{</span></code></li><li class="L0"><code class="language-json"><span class="pln">        </span><span class="str">"command"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"boot_whaley_image"</span></code></li><li class="L1"><code class="language-json"><span class="pln">        </span><span class="str">"parameters"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code class="language-json"><span class="pln">            </span><span class="pun">#</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">:</span><span class="pln"> burn the image</span><span class="pun">;</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">:</span><span class="pln"> don</span><span class="str">'</span><span class="pln">t burn the image</span><span class="pun">,</span><span class="pln"> run the test script directly </span><span class="pun">#</span></code></li><li class="L3"><code class="language-json"><span class="pln">            </span><span class="str">"skip"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">true</span><span class="pun">|</span><span class="kwd">false</span><span class="pun">]</span></code></li><li class="L4"><code class="language-json"><span class="pln">        </span><span class="pun">}</span></code></li><li class="L5"><code class="language-json"><span class="pln">    </span><span class="pun">},</span></code></li><li class="L6"><code class="language-json"><span class="pln">    </span><span class="pun">{</span></code></li><li class="L7"><code class="language-json"><span class="pln">        </span><span class="str">"command"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"whaley_test_shell"</span><span class="pun">,</span></code></li><li class="L8"><code class="language-json"><span class="pln">        </span><span class="str">"parameters"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code class="language-json"><span class="pln">            </span><span class="str">"script"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"/home/xxx/xxx/TAP/whaleyTAP.py parm1 parm2"</span><span class="pln"> </span><span class="pun">#</span><span class="pln"> user defined script </span><span class="pun">#,</span></code></li><li class="L0"><code class="language-json"><span class="pln">            </span><span class="str">"debug"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">true</span><span class="pun">|</span><span class="kwd">false</span><span class="pun">]</span></code></li><li class="L1"><code class="language-json"><span class="pln">            </span><span class="str">"case_debug"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"factoryReset"</span><span class="pln"> </span><span class="pun">#</span><span class="pln"> which case suite for debug</span></code></li><li class="L2"><code class="language-json"><span class="pln">        </span><span class="pun">}</span></code></li><li class="L3"><code class="language-json"><span class="pln">    </span><span class="pun">},</span></code></li><li class="L4"><code class="language-json"><span class="pln">    </span><span class="pun">{</span></code></li><li class="L5"><code class="language-json"><span class="pln">        </span><span class="str">"command"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"submit_results"</span><span class="pun">,</span></code></li><li class="L6"><code class="language-json"><span class="pln">        </span><span class="str">"parameters"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L7"><code class="language-json"><span class="pln">            </span><span class="str">"server"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"http://172.16.10.41/RPC2/"</span><span class="pun">,</span></code></li><li class="L8"><code class="language-json"><span class="pln">            </span><span class="pun">#</span><span class="pln"> available values</span><span class="pun">:</span><span class="pln"> http</span><span class="pun">://</span><span class="pln">validation</span><span class="pun">.</span><span class="pln">whaley</span><span class="pun">.</span><span class="pln">work</span><span class="pun">/</span><span class="pln">dashboard</span><span class="pun">/</span><span class="pln">streams</span><span class="pun">/</span><span class="pln"> </span><span class="pun">#</span></code></li><li class="L9"><code class="language-json"><span class="pln">            </span><span class="str">"stream"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"/anonymous/mstar-43/"</span><span class="pln"> </span><span class="pun">#</span><span class="pln"> for mstar </span><span class="lit">43</span><span class="pln"> platform only </span><span class="pun">#</span></code></li><li class="L0"><code class="language-json"><span class="pln">        </span><span class="pun">}</span></code></li><li class="L1"><code class="language-json"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L2"><code class="language-json"><span class="pun">],</span></code></li><li class="L3"><code class="language-json"><span class="str">"device_type"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"mstar"</span><span class="pun">,</span><span class="pln"> </span><span class="pun">#</span><span class="pln"> mstar</span><span class="pun">/</span><span class="pln">hisi</span><span class="pun">,</span><span class="pln"> etc</span><span class="pun">.</span><span class="pln"> </span><span class="pun">#</span></code></li><li class="L4"><code class="language-json"><span class="str">"health_check"</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">,</span></code></li><li class="L5"><code class="language-json"><span class="str">"job_name"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"mstar01-test-xxxxxxx"</span><span class="pun">,</span></code></li><li class="L6"><code class="language-json"><span class="str">"logging_level"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"DEBUG"</span><span class="pun">,</span></code></li><li class="L7"><code class="language-json"><span class="str">"platform_tags"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span><span class="pln"> </span><span class="pun">#</span><span class="pln"> list all platforms in current LAVA</span><span class="pun">,</span><span class="pln"> filter the jenkins email</span><span class="pun">#</span></code></li><li class="L8"><code class="language-json"><span class="pln">    </span><span class="str">"H01P43D"</span><span class="pun">,</span></code></li><li class="L9"><code class="language-json"><span class="pln">    </span><span class="str">"H02P43D"</span><span class="pun">,</span></code></li><li class="L0"><code class="language-json"><span class="pln">    </span><span class="pun">...</span></code></li><li class="L1"><code class="language-json"><span class="pun">]</span></code></li><li class="L2"><code class="language-json"><span class="str">"tags"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span><span class="pln"> </span></code></li><li class="L3"><code class="language-json"><span class="pln">    </span><span class="pun">#</span><span class="pln"> which device type to run the job</span><span class="pun">,</span><span class="pln"> H01P43D</span><span class="pun">/</span><span class="pln">H02P43D</span><span class="pun">,</span><span class="pln"> etc</span><span class="pun">.</span><span class="pln"> </span><span class="pun">#</span></code></li><li class="L4"><code class="language-json"><span class="pln">    </span><span class="pun">#</span><span class="pln"> </span><span class="typ">Get</span><span class="pln"> case directory in </span><span class="pun">/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">lava</span><span class="pun">-</span><span class="pln">dispatcher</span><span class="pun">/</span><span class="pln">case</span><span class="pun">.</span><span class="pln">json based on the tags </span><span class="pun">#</span></code></li><li class="L5"><code class="language-json"><span class="pln">    </span><span class="str">"H01P43D"</span></code></li><li class="L6"><code class="language-json"><span class="pun">]</span></code></li><li class="L7"><code class="language-json"><span class="str">"timeout"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1200</span></code></li><li class="L8"><code class="language-json"><span class="pun">}</span></code></li></ol></pre>

<p>If debug=false, LAVA will create one file named LAVA.json in <code>TAP/case/result/xx</code> based on <code>TAP/plan/LAVA.json</code>, and then run whaleyTAP.py. All test cases suite in LAVA.json will run automatically. <br>
LAVA.json demo:</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-json"><span class="pun">{</span></code></li><li class="L1"><code class="language-json"><span class="str">"device"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code class="language-json"><span class="pln">    </span><span class="str">"target"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"172.16.117.188:5555"</span><span class="pun">,</span></code></li><li class="L3"><code class="language-json"><span class="pln">    </span><span class="str">"telnet"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">2000</span><span class="pun">,</span></code></li><li class="L4"><code class="language-json"><span class="pln">    </span><span class="str">"tty"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"ttyUSB0"</span><span class="pun">,</span></code></li><li class="L5"><code class="language-json"><span class="pln">    </span><span class="str">"pdu"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"01"</span><span class="pun">,</span></code></li><li class="L6"><code class="language-json"><span class="pln">    </span><span class="str">"image"</span><span class="pun">:</span><span class="pln"> </span><span class="str">""</span><span class="pun">,</span></code></li><li class="L7"><code class="language-json"><span class="pln">    </span><span class="str">"platform"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"H01P55D"</span></code></li><li class="L8"><code class="language-json"><span class="pun">},</span></code></li><li class="L9"><code class="language-json"><span class="str">"mode"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L0"><code class="language-json"><span class="pln">    </span><span class="str">"debug"</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">,</span></code></li><li class="L1"><code class="language-json"><span class="pln">    </span><span class="str">"case"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"multiMedia"</span><span class="pun">,</span></code></li><li class="L2"><code class="language-json"><span class="pln">    </span><span class="str">"loop"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1</span></code></li><li class="L3"><code class="language-json"><span class="pun">},</span></code></li><li class="L4"><code class="language-json"><span class="str">"case"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[{</span></code></li><li class="L5"><code class="language-json"><span class="pln">    </span><span class="str">"name"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"multiMedia"</span><span class="pun">,</span></code></li><li class="L6"><code class="language-json"><span class="pln">    </span><span class="str">"loop"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1</span></code></li><li class="L7"><code class="language-json"><span class="pun">},</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L8"><code class="language-json"><span class="pln">    </span><span class="str">"name"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"factoryReset"</span><span class="pun">,</span></code></li><li class="L9"><code class="language-json"><span class="pln">    </span><span class="str">"loop"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1</span></code></li><li class="L0"><code class="language-json"><span class="pun">},</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L1"><code class="language-json"><span class="pln">   </span><span class="str">"name"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"tvApplication"</span><span class="pun">,</span></code></li><li class="L2"><code class="language-json"><span class="pln">   </span><span class="str">"loop"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1</span></code></li><li class="L3"><code class="language-json"><span class="pun">}]</span></code></li><li class="L4"><code class="language-json"><span class="pun">}</span></code></li></ol></pre>

<p>If debug=true, LAVA will create one file named LAVA_debug_job-id.json in <code>TAP/plan</code> based on <code>TAP/plan/LAVA.json</code>, but only the case suite <code>case_debug</code> defined in <code>whaley_test_shell</code> will run later. For example, in below demo, whaleyTAP.py only run the case <font color="red"><strong>debug.py</strong></font> in case suite <font color="red"><strong>factoryReset</strong></font>.</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-json"><span class="pun">{</span></code></li><li class="L1"><code class="language-json"><span class="str">"device"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code class="language-json"><span class="pln">    </span><span class="str">"tty"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"ttyUSB2"</span><span class="pun">,</span><span class="pln"> </span></code></li><li class="L3"><code class="language-json"><span class="pln">    </span><span class="str">"target"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"172.16.117.208:5555"</span><span class="pun">,</span><span class="pln"> </span></code></li><li class="L4"><code class="language-json"><span class="pln">    </span><span class="str">"pdu"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"02"</span><span class="pun">,</span><span class="pln"> </span></code></li><li class="L5"><code class="language-json"><span class="pln">    </span><span class="str">"telnet"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">2001</span><span class="pun">,</span><span class="pln"> </span></code></li><li class="L6"><code class="language-json"><span class="pln">    </span><span class="str">"platform"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"H02P43D"</span><span class="pun">,</span><span class="pln"> </span></code></li><li class="L7"><code class="language-json"><span class="pln">    </span><span class="str">"image"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"H02P43D-01.08.00-1608201-8"</span></code></li><li class="L8"><code class="language-json"><span class="pun">},</span><span class="pln"> </span></code></li><li class="L9"><code class="language-json"><span class="str">"case"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L0"><code class="language-json"><span class="pln">    </span><span class="pun">{</span></code></li><li class="L1"><code class="language-json"><span class="pln">        </span><span class="str">"name"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"multiMedia"</span><span class="pun">,</span><span class="pln"> </span></code></li><li class="L2"><code class="language-json"><span class="pln">        </span><span class="str">"loop"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1</span></code></li><li class="L3"><code class="language-json"><span class="pln">    </span><span class="pun">},</span><span class="pln"> </span></code></li><li class="L4"><code class="language-json"><span class="pln">    </span><span class="pun">{</span></code></li><li class="L5"><code class="language-json"><span class="pln">        </span><span class="str">"name"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"factoryReset"</span><span class="pun">,</span><span class="pln"> </span></code></li><li class="L6"><code class="language-json"><span class="pln">        </span><span class="str">"loop"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1</span></code></li><li class="L7"><code class="language-json"><span class="pln">    </span><span class="pun">},</span><span class="pln"> </span></code></li><li class="L8"><code class="language-json"><span class="pln">    </span><span class="pun">{</span></code></li><li class="L9"><code class="language-json"><span class="pln">        </span><span class="str">"name"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"tvApplication"</span><span class="pun">,</span><span class="pln"> </span></code></li><li class="L0"><code class="language-json"><span class="pln">        </span><span class="str">"loop"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1</span></code></li><li class="L1"><code class="language-json"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L2"><code class="language-json"><span class="pun">],</span><span class="pln"> </span></code></li><li class="L3"><code class="language-json"><span class="str">"mode"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L4"><code class="language-json"><span class="pln">    </span><span class="str">"debug"</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">,</span><span class="pln"> </span></code></li><li class="L5"><code class="language-json"><span class="pln">    </span><span class="str">"case"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"factoryReset"</span><span class="pun">,</span><span class="pln"> </span></code></li><li class="L6"><code class="language-json"><span class="pln">    </span><span class="str">"loop"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1</span></code></li><li class="L7"><code class="language-json"><span class="pun">}</span></code></li><li class="L8"><code class="language-json"><span class="pun">}</span></code></li></ol></pre>

<p><code>stream</code> in <code>submit_results</code> means where to collect the test results, here  if you run the script in mstar 43 platform, you can set it to "/anonymous/mstar-43/". For mstar 55 platfrom, you can set it to "/anonymous/mstar-55/". <br>
We have different devices connected to the PC, so we must set one parameter to distinguish them, here we use <code>tags</code> to achieve such goal. And for mstar 43 platform, we can set <code>tags</code> to ["H01P43D"] or ["H02P43D"] or ["H01P43D, "H02P43D"]. Add more tags in the future. <br>
Then use <code>sudo lava-dispatch --target {TARGET} --output-dir {OUTPUT_DIR} /tmp/whaley.json</code> to run the job, {TARGET} is the target device, {OUTPUT_DIR} is the directory to save the output log. But this command <strong>doesn't submit the job the LAVA server</strong>, you can use this to run the job locally and check the results. <br>
Otherwise you can use <code>sudo lava-tool submit-job http://&lt;username&gt;@&lt;server_ip&gt;/RPC2/ /tmp/whaley.json</code> to submit the job the LAVA server and view the results online. Here, <code>username</code> is lava, <code>server_ip</code> is 172.16.10.41.</p></li>
<li><p>Now we have different devices connect to several clients. We mush make sure that the case directories are the same in different clients. So set username to <code>dqa</code> in all clients, and each client should mount the same directory <code>/home/dqa/workspace/android-automation</code> in DQA. Please refer to 2.2.3 to add id_rsa.pub, and use below command in DQA3 to mount the directory in DQA.</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-shell"><span class="pln">sshfs </span><span class="pun">-</span><span class="pln">o allow_root </span><span class="pun">-</span><span class="pln">o reconnect dqa@172</span><span class="pun">.</span><span class="lit">16.117</span><span class="pun">.</span><span class="lit">1</span><span class="pun">:</span><span class="str">/home/</span><span class="pln">dqa</span><span class="pun">/</span><span class="pln">workspace</span><span class="pun">/</span><span class="pln">android_automation </span><span class="pun">/</span><span class="pln">home</span><span class="pun">/</span><span class="pln">dqa</span><span class="pun">/</span><span class="pln">workspace</span><span class="pun">/</span><span class="pln">android</span><span class="pun">-</span><span class="pln">automation</span></code></li></ol></pre>

<p>And LAVA will checkout the lateset code of android-automation in git to <code>/home/dqa/workspace/LAVA/android-automation</code>.</p></li>
</ol><div class="md-section-divider"></div><h3 data-anchor-id="ks7x" id="41-ldap"><strong>4.1 LDAP</strong></h3><p data-anchor-id="urv0">Add below lines in <code>/etc/lava-server/settings</code></p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="inwt"><ol class="linenums"><li class="L0"><code class="language-json"><span class="str">"AUTH_LDAP_SERVER_URI"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"ldap://172.16.xx.xx:389"</span><span class="pun">,</span></code></li><li class="L1"><code class="language-json"><span class="str">"AUTH_LDAP_BIND_DN"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"cn=ldapxxadmin,cn=users,dc=smarthome,dc=com"</span><span class="pun">,</span><span class="pln"> </span><span class="pun">#</span><span class="pln"> admin</span><span class="pun">对应的登录</span><span class="pln">CN</span><span class="pun">,</span><span class="pln"> </span><span class="pun">完整路径</span></code></li><li class="L2"><code class="language-json"><span class="str">"AUTH_LDAP_BIND_PASSWORD"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"xxpasswordxx"</span><span class="pun">,</span><span class="pln"> </span><span class="pun">#</span><span class="pln"> admin</span><span class="pun">登录</span><span class="pln">LDAP</span><span class="pun">的密码</span></code></li><li class="L3"><code class="language-json"><span class="pun">#</span><span class="pln"> ou</span><span class="pun">=</span><span class="typ">ShangHai</span><span class="pun">组下的所有用户,</span><span class="pln"> </span><span class="pun">有的</span><span class="pln">LDAP</span><span class="pun">登录名为(</span><span class="pln">uid</span><span class="pun">=%(</span><span class="pln">user</span><span class="pun">)</span><span class="pln">s</span><span class="pun">)</span></code></li><li class="L4"><code class="language-json"><span class="pun">#</span><span class="pln"> </span><span class="pun">这取决于不同的</span><span class="pln">LDAP</span><span class="pun">软件,</span><span class="pln"> </span><span class="pun">如</span><span class="typ">Microsoft</span><span class="pln"> AD</span><span class="pun">则为</span><span class="pln">sAMAccountName</span><span class="pun">,</span><span class="pln"> </span><span class="pun">需要事先知晓每个字段的配置</span></code></li><li class="L5"><code class="language-json"><span class="str">"AUTH_LDAP_USER_SEARCH"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"LDAPSearch('ou=ShangHai,dc=smarthome,dc=com',ldap.SCOPE_SUBTREE, '(sAMAccountName=%(user)s)')"</span><span class="pun">,</span></code></li><li class="L6"><code class="language-json"><span class="pun">#</span><span class="pln"> </span><span class="pun">查询对应</span><span class="pln">ou</span><span class="pun">=</span><span class="typ">ShangHai</span><span class="pun">下的所有组信息,</span><span class="pln"> objectClass</span><span class="pun">=</span><span class="pln">group</span></code></li><li class="L7"><code class="language-json"><span class="str">"AUTH_LDAP_GROUP_SEARCH"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"LDAPSearch('ou=ShangHai,dc=smarthome,dc=com',ldap.SCOPE_SUBTREE, '(objectClass=group)')"</span><span class="pun">,</span></code></li><li class="L8"><code class="language-json"><span class="pun">#</span><span class="pln"> </span><span class="pun">查询组的约束条件为</span><span class="pln">cn</span><span class="pun">=</span><span class="pln">xxx</span></code></li><li class="L9"><code class="language-json"><span class="pun">#</span><span class="pln"> </span><span class="pun">比如下面的</span><span class="pln">cn</span><span class="pun">=</span><span class="typ">SystemSoftware_Group</span><span class="pun">,</span><span class="pln"> </span><span class="pun">其为</span><span class="pln">AUTH_LDAP_GROUP_SEARCH</span><span class="pun">查到的某一组</span></code></li><li class="L0"><code class="language-json"><span class="str">"AUTH_LDAP_GROUP_TYPE"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"GroupOfNamesType(name_attr='cn')"</span><span class="pun">,</span></code></li><li class="L1"><code class="language-json"><span class="str">"AUTH_LDAP_USER_ATTR_MAP"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code class="language-json"><span class="pln">    </span><span class="str">"first_name"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"givenName"</span><span class="pun">,</span><span class="pln"> </span><span class="pun">#</span><span class="pln"> </span><span class="pun">字段取决于</span><span class="pln">LDAP</span><span class="pun">软件中的配置</span></code></li><li class="L3"><code class="language-json"><span class="pln">    </span><span class="str">"last_name"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"sn"</span><span class="pun">,</span></code></li><li class="L4"><code class="language-json"><span class="pln">    </span><span class="str">"email"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"userPrincipalName"</span><span class="pln"> </span><span class="pun">#</span><span class="pln"> </span><span class="pun">有些为</span><span class="pln">mail</span></code></li><li class="L5"><code class="language-json"><span class="pun">},</span></code></li><li class="L6"><code class="language-json"><span class="pun">#</span><span class="pln"> </span><span class="pun">对不同组用户设置登录权限</span></code></li><li class="L7"><code class="language-json"><span class="pun">#</span><span class="pln"> </span><span class="pun">当前配置:</span><span class="pln"> </span><span class="pun">仅</span><span class="typ">SystemSoftware_Group</span><span class="pun">用户可以登录当前系统,</span><span class="pln"> </span><span class="pun">并且为普通用户</span></code></li><li class="L8"><code class="language-json"><span class="str">"AUTH_LDAP_USER_FLAGS_BY_GROUP"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code class="language-json"><span class="pln">    </span><span class="str">"is_staff"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"ou=ShangHai,dc=smarthome,dc=com"</span><span class="pun">,</span></code></li><li class="L0"><code class="language-json"><span class="pln">    </span><span class="str">"is_active"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"cn=SystemSoftware_Group,ou=ShangHai,dc=smarthome,dc=com"</span><span class="pun">,</span></code></li><li class="L1"><code class="language-json"><span class="pln">    </span><span class="str">"is_superuser"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"ou=ShangHai,dc=smarthome,dc=com"</span></code></li><li class="L2"><code class="language-json"><span class="pun">},</span></code></li><li class="L3"><code class="language-json"><span class="pun">#</span><span class="pln"> disable openID</span></code></li><li class="L4"><code class="language-json"><span class="str">"DISABLE_OPENID_AUTH"</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">,</span></code></li><li class="L5"><code class="language-json"><span class="pun">#</span><span class="pln"> set LDAP login info</span></code></li><li class="L6"><code class="language-json"><span class="str">"LOGIN_MESSAGE_LDAP"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"If your email is first.second@whaley.cn then use first.second as your username"</span><span class="pun">,</span></code></li><li class="L7"><code class="language-json"><span class="pun">#</span><span class="pln"> only support json yet</span></code></li><li class="L8"><code class="language-json"><span class="str">"PIPELINE"</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">false</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="5q8q" id="42-install-from-source-code"><strong>4.2 Install from Source Code</strong></h3><p data-anchor-id="rdof">Clone the source code form git, and install the dependencies follow <code>precondition.sh</code> before build the source code.</p><ul data-anchor-id="7yq4">
<li><strong>Build from source code</strong></li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="tvu7"><ol class="linenums"><li class="L0"><code class="language-shell"><span class="com"># follow below steps</span></code></li><li class="L1"><code class="language-shell"><span class="com"># build lavapdu</span></code></li><li class="L2"><code class="language-shell"><span class="pln">cd LAVA</span><span class="pun">/</span><span class="pln">sourceCode</span><span class="pun">/</span><span class="pln">lavapdu</span><span class="pun">/</span><span class="pln">lavapdu</span><span class="pun">-</span><span class="lit">0.0</span><span class="pun">.</span><span class="lit">5</span></code></li><li class="L3"><code class="language-shell"><span class="pun">./</span><span class="pln">debian</span><span class="pun">-</span><span class="pln">dev</span><span class="pun">-</span><span class="pln">build</span><span class="pun">.</span><span class="pln">sh lavapdu</span></code></li><li class="L4"><code class="language-shell"><span class="com"># build lava-coordinator</span></code></li><li class="L5"><code class="language-shell"><span class="pln">cd LAVA</span><span class="pun">/</span><span class="pln">sourceCode</span><span class="pun">/</span><span class="pln">lava</span><span class="pun">-</span><span class="pln">coordinator</span><span class="pun">/</span><span class="pln">lava</span><span class="pun">-</span><span class="pln">coordinator</span><span class="pun">-</span><span class="lit">0.1</span><span class="pun">.</span><span class="lit">7</span></code></li><li class="L6"><code class="language-shell"><span class="pun">./</span><span class="pln">debian</span><span class="pun">-</span><span class="pln">dev</span><span class="pun">-</span><span class="pln">build</span><span class="pun">.</span><span class="pln">sh lava</span><span class="pun">-</span><span class="pln">coordinator</span></code></li><li class="L7"><code class="language-shell"><span class="com"># build lava-tool</span></code></li><li class="L8"><code class="language-shell"><span class="pln">cd LAVA</span><span class="pun">/</span><span class="pln">sourceCode</span><span class="pun">/</span><span class="pln">lava</span><span class="pun">-</span><span class="pln">tool</span><span class="pun">/</span><span class="pln">lava</span><span class="pun">-</span><span class="pln">tool</span><span class="pun">-</span><span class="lit">0.13</span></code></li><li class="L9"><code class="language-shell"><span class="pun">./</span><span class="pln">debian</span><span class="pun">-</span><span class="pln">dev</span><span class="pun">-</span><span class="pln">build</span><span class="pun">.</span><span class="pln">sh lava</span><span class="pun">-</span><span class="pln">tool</span></code></li><li class="L0"><code class="language-shell"><span class="com"># build lava-dispatcher</span></code></li><li class="L1"><code class="language-shell"><span class="pln">cd LAVA</span><span class="pun">/</span><span class="pln">sourceCode</span><span class="pun">/</span><span class="pln">lava</span><span class="pun">-</span><span class="pln">dispatcher</span><span class="pun">-</span><span class="lit">2015.8</span><span class="pun">.</span><span class="lit">1</span></code></li><li class="L2"><code class="language-shell"><span class="pun">./</span><span class="pln">debian</span><span class="pun">-</span><span class="pln">dev</span><span class="pun">-</span><span class="pln">build</span><span class="pun">.</span><span class="pln">sh lava</span><span class="pun">-</span><span class="pln">dispatcher</span></code></li><li class="L3"><code class="language-shell"><span class="com"># build lava-server</span></code></li><li class="L4"><code class="language-shell"><span class="pln">cd LAVA</span><span class="pun">/</span><span class="pln">sourceCode</span><span class="pun">/</span><span class="pln">lava</span><span class="pun">-</span><span class="pln">server</span><span class="pun">-</span><span class="lit">2015.8</span><span class="pun">.</span><span class="lit">1</span></code></li><li class="L5"><code class="language-shell"><span class="pun">./</span><span class="pln">debian</span><span class="pun">-</span><span class="pln">dev</span><span class="pun">-</span><span class="pln">build</span><span class="pun">.</span><span class="pln">sh lava</span><span class="pun">-</span><span class="pln">server</span></code></li></ol></pre><p data-anchor-id="obkv">You can find the deb packages build from the source code in <code>/tmp</code> directory.</p><ul data-anchor-id="5w2j">
<li><strong>Install from deb packages</strong></li>
</ul><p data-anchor-id="5701">All deb packages list in <code>LAVA/debPackages</code>.</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="mn7e"><ol class="linenums"><li class="L0"><code class="language-shell"><span class="com"># follow precondition.sh to install dependencies, then install deb packages</span></code></li><li class="L1"><code class="language-shell"><span class="com"># install lavapdu</span></code></li><li class="L2"><code class="language-shell"><span class="pln">cd LAVA</span><span class="pun">/</span><span class="pln">debPackages</span><span class="pun">/</span><span class="pln">lavapdu</span></code></li><li class="L3"><code class="language-shell"><span class="pln">sudo dpkg </span><span class="pun">-</span><span class="pln">i lavapdu</span><span class="pun">-</span><span class="pln">client_0</span><span class="pun">.</span><span class="lit">0.5</span><span class="pun">-</span><span class="lit">1</span><span class="pln">_all</span><span class="pun">.</span><span class="pln">deb</span></code></li><li class="L4"><code class="language-shell"><span class="pln">sudo dpkg </span><span class="pun">-</span><span class="pln">i lavapdu</span><span class="pun">-</span><span class="pln">daemon_0</span><span class="pun">.</span><span class="lit">0.5</span><span class="pun">-</span><span class="lit">1</span><span class="pln">_all</span><span class="pun">.</span><span class="pln">deb</span></code></li><li class="L5"><code class="language-shell"><span class="com"># install lava-coordinator</span></code></li><li class="L6"><code class="language-shell"><span class="pln">cd LAVA</span><span class="pun">/</span><span class="pln">debPackages</span><span class="pun">/</span><span class="pln">lava</span><span class="pun">-</span><span class="pln">coordinator</span></code></li><li class="L7"><code class="language-shell"><span class="pln">sudo dpkg </span><span class="pun">-</span><span class="pln">i lava</span><span class="pun">-</span><span class="pln">coordinator_0</span><span class="pun">.</span><span class="lit">1.7</span><span class="pun">-</span><span class="lit">1</span><span class="pln">_all</span><span class="pun">.</span><span class="pln">deb</span></code></li><li class="L8"><code class="language-shell"><span class="com"># install lava-tool</span></code></li><li class="L9"><code class="language-shell"><span class="pln">cd LAVA</span><span class="pun">/</span><span class="pln">debPackages</span><span class="pun">/</span><span class="pln">lava</span><span class="pun">-</span><span class="pln">tool</span></code></li><li class="L0"><code class="language-shell"><span class="pln">sudo dpkg </span><span class="pun">-</span><span class="pln">i lava</span><span class="pun">-</span><span class="pln">tool_0</span><span class="pun">.</span><span class="lit">13</span><span class="pun">-</span><span class="lit">1</span><span class="pln">_all</span><span class="pun">.</span><span class="pln">deb</span></code></li><li class="L1"><code class="language-shell"><span class="com"># install lava-dispatcher</span></code></li><li class="L2"><code class="language-shell"><span class="pln">cd LAVA</span><span class="pun">/</span><span class="pln">debPackages</span><span class="pun">/</span><span class="pln">lava</span><span class="pun">-</span><span class="pln">dispatcher</span></code></li><li class="L3"><code class="language-shell"><span class="pln">sudo dpkg </span><span class="pun">-</span><span class="pln">i lava</span><span class="pun">-</span><span class="pln">dispatcher_2015</span><span class="pun">.</span><span class="lit">8.1</span><span class="pun">-</span><span class="lit">1</span><span class="pln">_amd64</span><span class="pun">.</span><span class="pln">deb</span></code></li><li class="L4"><code class="language-shell"><span class="com"># install lava-server</span></code></li><li class="L5"><code class="language-shell"><span class="pln">cd LAVA</span><span class="pun">/</span><span class="pln">debPackages</span><span class="pun">/</span><span class="pln">lava</span><span class="pun">-</span><span class="pln">server</span></code></li><li class="L6"><code class="language-shell"><span class="pln">sudo dpkg </span><span class="pun">-</span><span class="pln">i lava</span><span class="pun">-</span><span class="pln">dev_2015</span><span class="pun">.</span><span class="lit">8.1</span><span class="pun">-</span><span class="lit">1</span><span class="pln">_all</span><span class="pun">.</span><span class="pln">deb</span></code></li><li class="L7"><code class="language-shell"><span class="pln">sudo dpkg </span><span class="pun">-</span><span class="pln">i lava</span><span class="pun">-</span><span class="pln">server</span><span class="pun">-</span><span class="pln">doc_2015</span><span class="pun">.</span><span class="lit">8.1</span><span class="pun">-</span><span class="lit">1</span><span class="pln">_all</span><span class="pun">.</span><span class="pln">deb</span></code></li><li class="L8"><code class="language-shell"><span class="pln">sudo dpkg </span><span class="pun">-</span><span class="pln">i lava</span><span class="pun">-</span><span class="pln">server_2015</span><span class="pun">.</span><span class="lit">8.1</span><span class="pun">-</span><span class="lit">1</span><span class="pln">_all</span><span class="pun">.</span><span class="pln">deb</span></code></li></ol></pre><hr><div class="md-section-divider"></div><h2 data-anchor-id="nmp2" id="5-faq"><strong>5 FAQ</strong></h2><div class="md-section-divider"></div><h3 data-anchor-id="eoz8" id="51-tips"><strong>5.1 Tips</strong></h3><ul data-anchor-id="h2g7">
<li><p>uboot <br>
If we want to stop the uboot, we can hit any key, but the bootdelay is so short, only 0 second in mstar platform. It's not enough to get the "interrupt_prompt" information, then stop the autoboot of the bootloader. So we can extend the delay to 10 seconds manully, enter bootloader, run below commands (MStar platform):</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-shell"><span class="pln">setenv bootdelay </span><span class="lit">10</span></code></li><li class="L1"><code class="language-shell"><span class="pln">saveenv</span></code></li><li class="L2"><code class="language-shell"><span class="pln">reset</span></code></li></ol></pre></li>
<li><p>busybox <br>
LAVA use some commands to get information of DUT, like sed/awk, so we should install busybox in the test image.</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-shell"><span class="pln">su</span></code></li><li class="L1"><code class="language-shell"><span class="pln">mount </span><span class="pun">-</span><span class="pln">o remount</span><span class="pun">,</span><span class="pln">rw </span><span class="pun">/</span><span class="pln">system</span></code></li><li class="L2"><code class="language-shell"><span class="pln">cd </span><span class="pun">/</span><span class="pln">system</span><span class="pun">/</span><span class="pln">xbin</span></code></li><li class="L3"><code class="language-shell"><span class="pln">busybox </span><span class="pun">--</span><span class="pln">install </span><span class="pun">.</span></code></li></ol></pre>

<p>So all the commands in busybox will be installed in <code>/system/xbin</code>, then you can use <code>sed</code>, <code>awk</code>, etc. But, for <code>ifconfig</code> we should still use <code>busybox ifconfig</code> or <code>/system/xbin/ifconfig</code> instead of <code>ifconfig</code> to get the right information.</p></li>
</ul><div class="md-section-divider"></div><h3 data-anchor-id="345p" id="52-install-tftp-telnet-ssh"><strong>5.2 Install tftp, telnet, ssh</strong></h3><p data-anchor-id="f5rw"><font color="red">For personal use only, don't use below configurations to set LAVA.</font></p><ul data-anchor-id="t7eb">
<li><p><strong>tftp</strong></p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-bash"><span class="pln">sudo apt</span><span class="pun">-</span><span class="pln">get install tftpd</span><span class="pun">-</span><span class="pln">hpa tftp</span><span class="pun">-</span><span class="pln">hpa</span></code></li><li class="L1"><code class="language-bash"><span class="pln">sudo mkdir </span><span class="pun">/</span><span class="pln">tftp </span><span class="com"># share folder</span></code></li><li class="L2"><code class="language-bash"><span class="pln">sudo chmod </span><span class="pun">-</span><span class="pln">R </span><span class="lit">0777</span><span class="pln"> </span><span class="pun">/</span><span class="pln">tftp</span></code></li><li class="L3"><code class="language-bash"><span class="pln">sudo gedit </span><span class="pun">/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">default</span><span class="pun">/</span><span class="pln">tftp</span><span class="pun">-</span><span class="pln">hpa</span></code></li><li class="L4"><code class="language-bash"><span class="pln">    </span><span class="pun">[</span><span class="kwd">set</span><span class="pln"> TFTP_DIRECTORY </span><span class="pun">=</span><span class="pln"> </span><span class="str">"/tftp"</span><span class="pun">]</span></code></li><li class="L5"><code class="language-bash"><span class="pln">    </span><span class="pun">[</span><span class="kwd">set</span><span class="pln"> TFTP_OPTIONS </span><span class="pun">=</span><span class="pln"> </span><span class="str">"-l -c -s"</span><span class="pun">]</span></code></li><li class="L6"><code class="language-bash"><span class="pln">sudo service tftpd</span><span class="pun">-</span><span class="pln">hpa restart</span></code></li><li class="L7"><code class="language-bash"><span class="pln">cd </span><span class="pun">/</span><span class="pln">tftp</span></code></li><li class="L8"><code class="language-bash"><span class="pln">touch test</span><span class="pun">.</span><span class="pln">txt</span></code></li><li class="L9"><code class="language-bash"><span class="pln">cd </span><span class="pun">~</span></code></li><li class="L0"><code class="language-bash"><span class="pln">tftp localhost</span></code></li><li class="L1"><code class="language-bash"><span class="pln">    tftp</span><span class="pun">&gt;</span><span class="pln"> get test</span><span class="pun">.</span><span class="pln">txt</span></code></li><li class="L2"><code class="language-bash"><span class="pln">    tftp</span><span class="pun">&gt;</span><span class="pln"> q</span></code></li><li class="L3"><code class="language-bash"><span class="pln">ls test</span><span class="pun">.</span><span class="pln">txt</span></code></li></ol></pre></li>
<li><p><strong>telnet</strong></p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-bash"><span class="pln">sudo apt</span><span class="pun">-</span><span class="pln">get install xinetd telnetd</span></code></li><li class="L1"><code class="language-bash"><span class="pln">sudo service xinetd restart</span></code></li></ol></pre></li>
<li><p><strong>ssh</strong></p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-bash"><span class="pln">sudo apt</span><span class="pun">-</span><span class="pln">get install openssh</span><span class="pun">-</span><span class="pln">server </span></code></li></ol></pre></li>
</ul><hr><p data-anchor-id="tt1v"><font color="grey"><strong>Wang Bo (wang.bo@whaley.cn), 2016.03.19</strong></font></p></div>
</body>
</html>